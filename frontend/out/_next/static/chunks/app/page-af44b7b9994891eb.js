(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2177:function(e,t,r){Promise.resolve().then(r.bind(r,9928))},9928:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Q}});var s,a,n=r(7437),o=r(2265),l=r(9376);let i=null;function c(){return i||(i=localStorage.getItem("analytics_session_id"))||(i="sess_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),localStorage.setItem("analytics_session_id",i)),i}let d=[],u=null;function h(e,t,r){let s={category:e,action:t,label:null==r?void 0:r.label,value:null==r?void 0:r.value,data:null==r?void 0:r.data,timestamp:Date.now()};d.push(s),u||(u=setTimeout(()=>{m(),u=null},1e3))}async function m(){if(0===d.length)return;let e=[...d];d.length=0;try{await fetch("".concat("http://localhost:8000","/api/analytics/events"),{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":c()},body:JSON.stringify({events:e})})}catch(t){d.push(...e),console.error("[Analytics] Failed to send events:",t)}}function g(e,t){h("page_view","view",{label:e,data:{referrer:t,url:window.location.href}})}function x(e,t,r){h("search","submit",{label:e,value:t,data:{durationMs:r}})}function p(e,t,r){h("error",e,{label:t,data:{stack:null==r?void 0:r.slice(0,500)}})}{g(window.location.pathname,document.referrer);let e=history.pushState;history.pushState=function(){for(var t=arguments.length,r=Array(t),s=0;s<t;s++)r[s]=arguments[s];e.apply(history,r),g(window.location.pathname)},window.addEventListener("popstate",()=>{g(window.location.pathname)}),window.addEventListener("error",e=>{var t;p("uncaught_error",e.message,null===(t=e.error)||void 0===t?void 0:t.stack)}),window.addEventListener("unhandledrejection",e=>{p("unhandled_rejection",String(e.reason))}),window.addEventListener("beforeunload",()=>{d.length>0&&navigator.sendBeacon("".concat("http://localhost:8000","/api/analytics/events"),JSON.stringify({events:d,session_id:c()}))})}let f="shoppingagent_search_history",y="priceagent_search_history";function v(){try{let e=localStorage.getItem(f);if(!e)return[];return JSON.parse(e).map(e=>({...e,status:e.status||"completed"})).sort((e,t)=>t.timestamp-e.timestamp)}catch(e){return console.error("[SearchHistory] Failed to load:",e),[]}}function b(e){let t=v(),r={...e,id:"search_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9))};t.unshift(r);let s=t.slice(0,50);try{localStorage.setItem(f,JSON.stringify(s))}catch(e){console.error("[SearchHistory] Failed to save:",e)}return r}function j(e,t){let r=v(),s=r.findIndex(t=>t.traceId===e);if(-1===s)return console.warn("[SearchHistory] Item not found for traceId:",e),null;let a=r[s];void 0!==t.resultCount&&(a.resultCount=t.resultCount),void 0!==t.status&&(a.status=t.status),void 0!==t.error&&(a.error=t.error),void 0!==t.topResults&&(a.topResults=t.topResults),void 0!==t.searchTimeMs&&(a.searchTimeMs=t.searchTimeMs);try{localStorage.setItem(f,JSON.stringify(r))}catch(e){console.error("[SearchHistory] Failed to update:",e)}return a}function N(e){let t=v().filter(t=>t.id!==e);try{localStorage.setItem(f,JSON.stringify(t))}catch(e){console.error("[SearchHistory] Failed to delete:",e)}}function w(e){let t=Date.now()-e,r=Math.floor(t/6e4),s=Math.floor(t/36e5),a=Math.floor(t/864e5);return r<1?"Just now":r<60?"".concat(r,"m ago"):s<24?"".concat(s,"h ago"):a<7?"".concat(a,"d ago"):new Date(e).toLocaleDateString()}!function(){try{let e=localStorage.getItem(y),t=localStorage.getItem(f);e&&!t&&(console.log("[SearchHistory] Migrating from old storage key"),localStorage.setItem(f,e),localStorage.removeItem(y))}catch(e){console.error("[SearchHistory] Migration failed:",e)}}();var S=r(1837),k=r(7850),_=r(3425),C=r(9625);let L="shoppingagent_discovery_history";function D(){try{let e=localStorage.getItem(L);if(!e)return[];return JSON.parse(e).map(e=>({...e,status:e.status||"completed"})).sort((e,t)=>t.timestamp-e.timestamp)}catch(e){return console.error("[DiscoveryHistory] Failed to load:",e),[]}}let I=(0,C.Ue)((e,t)=>({query:"",country:"IL",isSearching:!1,isLoadingFromHistory:!1,currentTraceId:null,originalTraceId:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],error:null,statusMessage:null,history:[],messages:[],sessionId:null,setQuery:t=>e({query:t}),setCountry:t=>e({country:t}),setProducts:t=>e({products:t}),setError:t=>e({error:t}),setStatusMessage:t=>e({statusMessage:t}),clearResults:()=>e({products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],error:null,statusMessage:null,currentTraceId:null,originalTraceId:null,messages:[],sessionId:null}),clearConversation:()=>e({messages:[],sessionId:null}),loadHistory:()=>{e({history:D()})},runDiscovery:async(r,s)=>{let a=s||t().country,n="session_".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,9)),o={id:"msg_".concat(Date.now()),role:"user",content:r,timestamp:Date.now()};e({isSearching:!0,error:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],query:r,country:a,statusMessage:"Starting product discovery...",messages:[o],sessionId:n,currentTraceId:null,originalTraceId:null});try{let t=await S.h.runDiscovery(r,a),s=function(e){let t=D();if(e.traceId){let r=t.findIndex(t=>t.traceId===e.traceId);if(-1!==r){let s=t[r];s.productCount=e.productCount,s.timestamp=e.timestamp,s.status=e.status,e.error&&(s.error=e.error),t.splice(r,1),t.unshift(s);try{localStorage.setItem(L,JSON.stringify(t))}catch(e){console.error("[DiscoveryHistory] Failed to save:",e)}return s}}let r={...e,id:"discovery_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9))};t.unshift(r);let s=t.slice(0,50);try{localStorage.setItem(L,JSON.stringify(s))}catch(e){console.error("[DiscoveryHistory] Failed to save:",e)}return r}({query:r,timestamp:Date.now(),productCount:0,traceId:t.trace_id,status:"searching"});return e(e=>({currentTraceId:t.trace_id,originalTraceId:t.trace_id,statusMessage:"Researching products...",history:[s,...e.history.filter(e=>e.traceId!==t.trace_id).slice(0,49)]})),t.trace_id}catch(t){throw e({error:t instanceof Error?t.message:"Discovery failed",isSearching:!1,statusMessage:null}),t}},sendRefinement:async r=>{let{products:s,country:a,messages:n,sessionId:o,originalTraceId:l}=t();if(!o)throw Error("No active session");let i={id:"msg_".concat(Date.now()),role:"user",content:r,timestamp:Date.now(),productsSnapshot:s};e(e=>({isSearching:!0,error:null,statusMessage:"Refining search...",messages:[...e.messages,i]}));try{let t=n.map(e=>({role:e.role,content:e.content}));t.push({role:"user",content:r});let s=await S.h.runDiscoveryRefinement(r,a,t,o,l||void 0);return e({currentTraceId:s.trace_id,statusMessage:"Updating recommendations..."}),s.trace_id}catch(t){throw e({error:t instanceof Error?t.message:"Refinement failed",isSearching:!1,statusMessage:null}),t}},setSearchComplete:r=>{let{query:s,currentTraceId:a,originalTraceId:n}=t(),o=r.products||[],l=n&&a!==n;console.log("[Discovery] setSearchComplete:",{query:s,currentTraceId:a,originalTraceId:n,isRefinement:l,productCount:o.length});let i=o.length>0?"Found ".concat(o.length," product").concat(1===o.length?"":"s"," matching your criteria."):r.no_results_message||"No products found matching your criteria.",c={id:"msg_".concat(Date.now()),role:"assistant",content:i,timestamp:Date.now(),traceId:a||void 0,productsSnapshot:o};a&&!l?(console.log("[Discovery] Updating history status to completed:",a),function(e,t){let r=D(),s=r.findIndex(t=>t.traceId===e);if(-1===s)return console.warn("[DiscoveryHistory] Item not found for traceId:",e);let a=r[s];void 0!==t.productCount&&(a.productCount=t.productCount),void 0!==t.status&&(a.status=t.status),void 0!==t.error&&(a.error=t.error);try{localStorage.setItem(L,JSON.stringify(r))}catch(e){console.error("[DiscoveryHistory] Failed to update:",e)}}(a,{status:"completed",productCount:o.length}),e(e=>({products:o,searchSummary:r.search_summary||null,noResultsMessage:r.no_results_message||null,suggestions:r.suggestions||[],criteriaFeedback:r.criteria_feedback||[],isSearching:!1,statusMessage:null,history:e.history.map(e=>e.traceId===a?{...e,status:"completed",productCount:o.length}:e),messages:[...e.messages,c]}))):e(e=>({products:o,searchSummary:r.search_summary||null,noResultsMessage:r.no_results_message||null,suggestions:r.suggestions||[],criteriaFeedback:r.criteria_feedback||[],isSearching:!1,statusMessage:null,messages:[...e.messages,c]}))},loadFromTrace:async(t,r)=>{e({isSearching:!0,isLoadingFromHistory:!0,error:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],query:r,currentTraceId:t,originalTraceId:t,statusMessage:"Loading previous results...",messages:[],sessionId:"session_".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,9))});try{var s;let a="http://localhost:8000",n=await fetch("".concat(a,"/traces/"));if(!n.ok)throw Error("Failed to load traces");let o=await n.json(),l=null===(s=o.traces)||void 0===s?void 0:s.find(e=>e.id===t),i=await fetch("".concat(a,"/traces/").concat(t));if(!i.ok)throw Error("Failed to load trace");let c=await i.json();console.log("[Discovery] Loaded trace:",t,"status:",c.status,"has final_output:",!!c.final_output);let d=e=>{if(!e)return{products:[]};try{let t="string"==typeof e?JSON.parse(e):e;if(t.products&&Array.isArray(t.products))return t;if(Array.isArray(t))return{products:t}}catch(e){console.log("[Discovery] Could not parse trace output as products")}return{products:[]}},u=e=>{let t=e.match(/User's refinement request:\s*(.+?)(?:\n|$)/);if(t)return t[1].trim();let r=e.match(RegExp("New user message:\\s*(.+)","s"));return r?r[1].trim():e},h=c.final_output||c.output||"",m=d(h);console.log("[Discovery] Parsed",m.products.length,"products from parent trace");let g=[],x=Date.now()-1e4;g.push({id:"msg_".concat(x,"_user"),role:"user",content:r,timestamp:x}),x+=1e3,g.push({id:"msg_".concat(x,"_assistant"),role:"assistant",content:m.products.length>0?"Found ".concat(m.products.length," product").concat(1===m.products.length?"":"s"," matching your criteria."):m.no_results_message||"No products found.",timestamp:x,traceId:t,productsSnapshot:m.products}),x+=1e3;let p=m.products,f=m,y=t,v=(null==l?void 0:l.child_traces)||[];if(v.length>0)for(let e of(console.log("[Discovery] Loading",v.length,"child traces (refinements)"),v)){let t=await fetch("".concat(a,"/traces/").concat(e.id));if(t.ok){let r=await t.json(),s=d(r.final_output||r.output||""),a=u(e.input_prompt||"");g.push({id:"msg_".concat(x,"_user"),role:"user",content:a,timestamp:x,productsSnapshot:p}),x+=1e3,g.push({id:"msg_".concat(x,"_assistant"),role:"assistant",content:s.products.length>0?"Found ".concat(s.products.length," product").concat(1===s.products.length?"":"s"," matching your criteria."):s.no_results_message||"No products found.",timestamp:x,traceId:e.id,productsSnapshot:s.products}),x+=1e3,s.products.length>0&&(p=s.products,f=s,y=e.id)}}e({products:p,searchSummary:f.search_summary||null,noResultsMessage:f.no_results_message||null,suggestions:f.suggestions||[],criteriaFeedback:f.criteria_feedback||[],isSearching:!1,isLoadingFromHistory:!1,statusMessage:null,messages:g,currentTraceId:y})}catch(t){e({error:t instanceof Error?t.message:"Failed to load",isSearching:!1,isLoadingFromHistory:!1,statusMessage:null,sessionId:null})}},deleteFromHistory:t=>{!function(e){let t=D().filter(t=>t.id!==e);try{localStorage.setItem(L,JSON.stringify(t))}catch(e){console.error("[DiscoveryHistory] Failed to delete:",e)}}(t),e(e=>({history:e.history.filter(e=>e.id!==t)}))},loadFromMessage:r=>{let{messages:s}=t(),a=s.find(e=>e.id===r);a&&a.productsSnapshot&&e({products:a.productsSnapshot,currentTraceId:a.traceId||null})}}));function M(e){let{products:t,onAddToList:r,isAddingId:s}=e;return t&&0!==t.length?(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("h3",{className:"text-lg font-semibold text-gray-800",children:["Recommended Products (",t.length,")"]}),(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsxs)("table",{className:"w-full text-sm",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{className:"border-b border-gray-200 text-left text-gray-500",children:[(0,n.jsx)("th",{className:"px-3 py-3",children:"#"}),(0,n.jsx)("th",{className:"px-3 py-3",children:"Product"}),(0,n.jsx)("th",{className:"px-3 py-3",children:"Brand"}),(0,n.jsx)("th",{className:"px-3 py-3",children:"Key Specs"}),(0,n.jsx)("th",{className:"px-3 py-3",children:"Price Range"}),(0,n.jsx)("th",{className:"px-3 py-3",children:"Why Recommended"}),(0,n.jsx)("th",{className:"px-3 py-3 text-center",children:"Action"})]})}),(0,n.jsx)("tbody",{children:t.map((e,t)=>(0,n.jsx)(F,{product:e,index:t+1,onAddToList:r,isAdding:s===e.id},e.id))})]})})]}):null}function F(e){let{product:t,index:r,onAddToList:s,isAdding:a}=e;return(0,n.jsxs)("tr",{className:"border-b border-gray-200/50 hover:bg-gray-50",children:[(0,n.jsx)("td",{className:"px-3 py-3 text-gray-400",children:r}),(0,n.jsxs)("td",{className:"px-3 py-3",children:[(0,n.jsx)("div",{className:"font-medium text-gray-800",children:t.name}),t.model_number&&(0,n.jsx)("div",{className:"text-sm font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded inline-block mt-1",children:t.model_number}),(0,n.jsx)("div",{className:"mt-1",children:t.url?(0,n.jsx)("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-indigo-600 hover:underline",children:"View product"}):(0,n.jsx)("a",{href:"https://www.google.com/search?q=".concat(encodeURIComponent((t.brand?t.brand+" ":"")+(t.model_number||t.name))),target:"_blank",rel:"noopener noreferrer",className:"text-xs text-indigo-600 hover:underline",children:"Search on Google"})})]}),(0,n.jsx)("td",{className:"px-3 py-3 text-gray-600",children:t.brand||"-"}),(0,n.jsx)("td",{className:"px-3 py-3",children:t.key_specs.length>0?(0,n.jsxs)("ul",{className:"space-y-0.5",children:[t.key_specs.slice(0,3).map((e,t)=>(0,n.jsxs)("li",{className:"text-xs text-gray-500",children:["• ",e]},t)),t.key_specs.length>3&&(0,n.jsxs)("li",{className:"text-xs text-gray-400",children:["+",t.key_specs.length-3," more"]})]}):(0,n.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,n.jsx)("td",{className:"px-3 py-3",children:t.price_range?(0,n.jsx)("span",{className:"text-emerald-600 font-medium",children:t.price_range}):t.price?(0,n.jsxs)("span",{className:"text-emerald-600 font-medium",children:["ILS"===t.currency?"₪":t.currency,t.price.toLocaleString()]}):(0,n.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,n.jsx)("td",{className:"px-3 py-3 max-w-xs",children:(0,n.jsx)("p",{className:"text-xs text-gray-500 line-clamp-2 cursor-help",title:t.why_recommended||void 0,children:t.why_recommended||"-"})}),(0,n.jsx)("td",{className:"px-3 py-3 text-center",children:(0,n.jsx)("button",{onClick:()=>s(t),disabled:a,className:"px-3 py-1.5 text-xs font-medium bg-indigo-50 text-indigo-600 hover:bg-indigo-500 hover:text-gray-800 disabled:opacity-50 disabled:cursor-wait rounded-lg transition-colors",children:a?"Adding...":"Add to List"})})]})}let E=[{code:"IL",name:"Israel",flag:"\uD83C\uDDEE\uD83C\uDDF1"},{code:"US",name:"United States",flag:"\uD83C\uDDFA\uD83C\uDDF8"},{code:"UK",name:"United Kingdom",flag:"\uD83C\uDDEC\uD83C\uDDE7"},{code:"DE",name:"Germany",flag:"\uD83C\uDDE9\uD83C\uDDEA"},{code:"FR",name:"France",flag:"\uD83C\uDDEB\uD83C\uDDF7"}];function P(e){let{value:t,onChange:r,compact:s=!1}=e;return(E.find(e=>e.code===t)||E[0],s)?(0,n.jsx)("select",{value:t,onChange:e=>r(e.target.value),className:"bg-white border border-gray-200 text-gray-600 text-sm rounded-lg px-2 py-1 outline-none focus:border-indigo-500 cursor-pointer",children:E.map(e=>(0,n.jsxs)("option",{value:e.code,children:[e.flag," ",e.code]},e.code))}):(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-sm text-gray-500",children:"Region:"}),(0,n.jsx)("select",{value:t,onChange:e=>r(e.target.value),className:"bg-white border border-gray-200 text-gray-600 text-sm rounded-lg px-3 py-1.5 outline-none focus:border-indigo-500 cursor-pointer",children:E.map(e=>(0,n.jsxs)("option",{value:e.code,children:[e.flag," ",e.name]},e.code))})]})}function T(e){try{let t=JSON.parse(e),r=e=>e.map((e,t)=>({id:String(e.id||"prod_".concat(Date.now(),"_").concat(t)),name:String(e.name||"Unknown Product"),brand:e.brand?String(e.brand):void 0,model_number:e.model_number?String(e.model_number):void 0,category:String(e.category||"product"),key_specs:Array.isArray(e.key_specs)?e.key_specs.map(String):[],price_range:e.price_range?String(e.price_range):void 0,why_recommended:String(e.why_recommended||""),price:"number"==typeof e.price?e.price:void 0,currency:e.currency?String(e.currency):void 0,url:e.url?String(e.url):void 0,rating:"number"==typeof e.rating?e.rating:void 0}));if(t.products&&Array.isArray(t.products))return{products:r(t.products),search_summary:t.search_summary,no_results_message:t.no_results_message,suggestions:t.suggestions,criteria_feedback:t.criteria_feedback};if(Array.isArray(t))return{products:r(t)};return console.log("[Discovery] Output is not a products array:",t),{products:[]}}catch(r){let t=e.match(/\{[\s\S]*"products"[\s\S]*\}/);if(t)try{let e=JSON.parse(t[0]);if(e.products&&Array.isArray(e.products))return T(JSON.stringify(e))}catch(e){console.log("[Discovery] Failed to extract JSON from output")}return console.log("[Discovery] Failed to parse output as JSON:",r),{products:[]}}}function O(e){let{onAddToShoppingList:t,country:r,onCountryChange:s}=e,{query:a,setQuery:l,country:i,setCountry:c,isSearching:d,isLoadingFromHistory:u,currentTraceId:h,products:m,searchSummary:g,noResultsMessage:x,suggestions:p,criteriaFeedback:f,error:y,statusMessage:v,messages:b,sessionId:j,setStatusMessage:N,setError:w,runDiscovery:S,sendRefinement:k,setSearchComplete:_,clearResults:C,loadFromMessage:L}=I();(0,o.useEffect)(()=>{r!==i&&c(r)},[r,i,c]);let[D,F]=(0,o.useState)(),[E,O]=(0,o.useState)(a),[W,R]=(0,o.useState)(""),B=(0,o.useRef)(null),z=(0,o.useRef)(null),A=(0,o.useRef)(null);(0,o.useEffect)(()=>{A.current=h},[h]),(0,o.useEffect)(()=>{a!==E&&O(a)},[a]),(0,o.useEffect)(()=>{if(!h||!d||u)return;B.current&&(B.current.close(),B.current=null);let e="http://localhost:8000",t=e.replace("http","ws")||"ws://localhost:8000";console.log("[Discovery] Connecting WebSocket for trace:",h);let r=new WebSocket("".concat(t,"/traces/ws"));return B.current=r,r.onopen=()=>{console.log("[Discovery] WebSocket connected for trace:",h)},r.onmessage=e=>{try{var t,s,a;let n=JSON.parse(e.data);if(n.trace_id!==h)return;if(A.current!==h){console.log("[Discovery] Ignoring message for old trace:",h),r.close();return}if("span_started"===n.event_type&&(null===(t=n.data)||void 0===t?void 0:t.name)&&N(n.data.name),"trace_ended"===n.event_type){if(console.log("[Discovery] Trace completed:",h),null===(s=n.data)||void 0===s?void 0:s.error)console.error("[Discovery] Trace error:",n.data.error),w(n.data.error),_({products:[]});else{let e=(null===(a=n.data)||void 0===a?void 0:a.final_output)||"";console.log("[Discovery] Final output length:",e.length),console.log("[Discovery] Final output preview:",e.substring(0,500));let t=T(e);console.log("[Discovery] Parsed products:",t.products.length),0===t.products.length&&e.length>0&&console.log("[Discovery] No products parsed, full output:",e),_(t)}r.close()}}catch(e){console.error("[Discovery] WebSocket message parse error:",e)}},r.onerror=e=>{console.error("[Discovery] WebSocket error:",e)},r.onclose=()=>{console.log("[Discovery] WebSocket closed for trace:",h),A.current===h&&setTimeout(()=>{let t=I.getState();t.isSearching&&t.currentTraceId===h&&(console.log("[Discovery] Fetching trace directly as fallback"),fetch("".concat(e,"/traces/").concat(h)).then(e=>e.json()).then(e=>{"completed"===e.status&&e.final_output?_(T(e.final_output)):"error"===e.status&&(w(e.error||"Discovery failed"),_({products:[]}))}).catch(e=>{console.error("[Discovery] Fallback fetch failed:",e)}))},100)},()=>{B.current&&(B.current.close(),B.current=null)}},[h,d,u,N,w,_]);let H=(0,o.useCallback)(async e=>{if(e.preventDefault(),E.trim()&&!d)try{await S(E,r)}catch(e){console.error("[Discovery] Search failed:",e)}},[E,d,S,r]),U=(0,o.useCallback)(e=>{F(e.id),t({product_name:e.name,model_number:e.model_number,specs_summary:e.key_specs.slice(0,3).join(", "),source:"discovery"}),setTimeout(()=>F(void 0),500)},[t]),J=e=>{O(e),l(e)},q=(0,o.useCallback)(async e=>{if(e.preventDefault(),W.trim()&&!d&&j)try{await k(W),R("")}catch(e){console.error("[Discovery] Refinement failed:",e)}},[W,d,j,k]);return(0,o.useEffect)(()=>{z.current&&b.length>0&&z.current.scrollIntoView({behavior:"smooth"})},[b.length]),(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-6",children:[(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"What are you looking for?"}),(0,n.jsx)("p",{className:"text-gray-500 text-sm mb-4",children:"Describe your needs in natural language - our AI will find the best products for you."}),(0,n.jsxs)("form",{onSubmit:H,className:"space-y-4",children:[(0,n.jsx)("textarea",{value:E,onChange:e=>O(e.target.value),placeholder:"Example: I need a silent refrigerator for a family of 4 with an open kitchen layout",dir:"auto",className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 outline-none resize-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-300",rows:3,disabled:d}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[s?(0,n.jsx)(P,{value:r,onChange:s,compact:!0}):(0,n.jsxs)("div",{className:"text-xs text-gray-400",children:["Country: ",r]}),(0,n.jsx)("button",{type:"submit",disabled:d||!E.trim(),className:"px-6 py-2.5 bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-400 hover:to-blue-400 disabled:from-gray-200 disabled:to-gray-200 text-white font-medium rounded-xl transition-all duration-300 flex items-center gap-2",children:d?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Discovering..."]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})}),"Discover Products"]})})]})]}),d&&v&&(0,n.jsx)("div",{className:"mt-4 text-center text-gray-500 text-sm animate-pulse",children:v}),y&&(0,n.jsx)("div",{className:"mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:y})]}),!d&&0===m.length&&!y&&(x||f.length>0||g)&&(0,n.jsxs)("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 space-y-4",children:[x&&(0,n.jsx)("div",{className:"text-amber-400 font-medium",children:x}),g&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"What we searched for:"}),(0,n.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,n.jsxs)("span",{className:"text-indigo-600",children:["“",g.original_requirement,"”"]}),g.category&&(0,n.jsxs)("span",{className:"ml-2 text-gray-400",children:["(",g.category,")"]})]}),g.search_attempts&&g.search_attempts.length>0&&(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsxs)("span",{className:"text-gray-400 text-xs",children:["Searched ",g.search_attempts.length," queries across"," ",g.search_attempts.reduce((e,t)=>{var r;return e+((null===(r=t.scrapers)||void 0===r?void 0:r.length)||0)},0)," sources"]})})]}),f.length>0&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"Search criteria used:"}),(0,n.jsx)("ul",{className:"text-gray-500 text-sm space-y-1",children:f.map((e,t)=>(0,n.jsx)("li",{className:"flex items-start",children:(0,n.jsx)("span",{className:"text-indigo-600 mr-2",children:e})},t))})]}),p.length>0&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"Suggestions:"}),(0,n.jsx)("ul",{className:"text-gray-500 text-sm space-y-1",children:p.map((e,t)=>(0,n.jsxs)("li",{className:"flex items-start",children:[(0,n.jsx)("span",{className:"text-amber-400 mr-2",children:"•"}),(0,n.jsx)("span",{children:e})]},t))})]}),(0,n.jsx)("button",{onClick:C,className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Clear and try again"})]}),!d&&0===m.length&&!y&&!x&&!g&&0===f.length&&(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("p",{className:"text-gray-400 text-sm mb-3",children:"Or try one of these examples:"}),(0,n.jsx)("div",{className:"flex flex-wrap justify-center gap-2",children:["Silent refrigerator for family of 4","Energy efficient washing machine for small apartment","Quiet dishwasher with good drying","Large capacity oven for baking"].map(e=>(0,n.jsx)("button",{onClick:()=>J(e),className:"px-3 py-1.5 text-sm text-gray-500 bg-white shadow-soft rounded-lg hover:bg-gray-100 hover:text-gray-800 transition-colors",children:e},e))})]}),m.length>0&&(0,n.jsxs)("div",{className:"bg-white/30 border border-gray-200 rounded-xl p-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("span",{className:"text-gray-500 text-sm",children:["Found ",m.length," recommended products"]}),(0,n.jsx)("button",{onClick:C,className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Clear results"})]}),(null==g?void 0:g.filtering_notes)&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:(0,n.jsxs)("div",{className:"text-blue-400 text-sm",children:[(0,n.jsx)("span",{className:"font-medium",children:"Note:"})," ",g.filtering_notes]})}),(null==g?void 0:g.market_notes)&&!(null==g?void 0:g.filtering_notes)&&(0,n.jsx)("div",{className:"mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg",children:(0,n.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,n.jsx)("span",{className:"font-medium",children:"Market info:"})," ",g.market_notes]})}),(0,n.jsx)(M,{products:m,onAddToList:U,isAddingId:D}),j&&(0,n.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-6",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-gray-600 mb-3",children:"Refine your search"}),b.length>1&&(0,n.jsxs)("div",{className:"mb-4 max-h-40 overflow-y-auto space-y-2 pr-2",children:[b.slice(1).map(e=>{let t="assistant"===e.role,r=t&&e.traceId===h,s=t&&e.productsSnapshot&&e.productsSnapshot.length>0;return(0,n.jsxs)("div",{onClick:()=>{s&&L(e.id)},className:"text-sm rounded-lg px-3 py-2 ".concat("user"===e.role?"bg-indigo-50 text-indigo-700 ml-8":"mr-8 ".concat(r?"bg-indigo-100 text-indigo-700 border border-indigo-300":"bg-gray-50 text-gray-600"," ").concat(s?"cursor-pointer hover:bg-gray-100":"")),title:s?"Click to view these results":void 0,children:[(0,n.jsxs)("span",{className:"font-medium",children:["user"===e.role?"You":"AI",":"]})," ",e.content,s&&(0,n.jsx)("span",{className:"ml-1 text-xs text-gray-400",children:"(click to view)"})]},e.id)}),(0,n.jsx)("div",{ref:z})]}),(0,n.jsxs)("form",{onSubmit:q,className:"flex gap-2",children:[(0,n.jsx)("input",{type:"text",value:W,onChange:e=>R(e.target.value),placeholder:"e.g., 'show cheaper options' or 'prefer Samsung'",dir:"auto",className:"flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition-all duration-300",disabled:d}),(0,n.jsxs)("button",{type:"submit",disabled:d||!W.trim(),className:"px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-400 hover:to-blue-400 disabled:from-gray-200 disabled:to-gray-200 text-white text-sm font-medium rounded-lg transition-all duration-300 flex items-center gap-1",children:[d?(0,n.jsxs)("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})}),"Refine"]})]}),(0,n.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:["cheaper options","quieter models","larger capacity","different brands"].map(e=>(0,n.jsx)("button",{onClick:()=>R(e),disabled:d,className:"text-xs text-gray-500 bg-white hover:bg-gray-100 px-2 py-1 rounded transition-colors disabled:opacity-50",children:e},e))})]})]})]})}function W(e,t){let r;try{r=e()}catch(e){return}return{getItem:e=>{var s;let a=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),n=null!=(s=r.getItem(e))?s:null;return n instanceof Promise?n.then(a):a(n)},setItem:(e,s)=>r.setItem(e,JSON.stringify(s,null==t?void 0:t.replacer)),removeItem:e=>r.removeItem(e)}}let R=e=>t=>{try{let r=e(t);if(r instanceof Promise)return r;return{then:e=>R(e)(r),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>R(t)(e)}}},B="shoppingagent_shopping_list",z="priceagent_shopping_list";!function(){try{let e=localStorage.getItem(z),t=localStorage.getItem(B);e&&!t&&(console.log("[ShoppingList] Migrating from old storage key"),localStorage.setItem(B,e),localStorage.removeItem(z))}catch(e){console.error("[ShoppingList] Migration failed:",e)}}();let A=(0,C.Ue)()((s=(e,t)=>({items:[],isLoading:!1,isSearching:!1,activeSearchSession:null,addItem:t=>{let r={...t,id:"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)),added_at:new Date().toISOString()};return e(e=>({items:[r,...e.items]})),r},removeItem:t=>{e(e=>({items:e.items.filter(e=>e.id!==t)}))},updateItem:(t,r)=>{e(e=>({items:e.items.map(e=>e.id===t?{...e,...r}:e)}))},clearList:()=>{e({items:[]})},getItemById:e=>t().items.find(t=>t.id===e),isDuplicate:e=>!!e&&t().items.some(t=>{var r;return(null===(r=t.model_number)||void 0===r?void 0:r.toLowerCase())===e.toLowerCase()}),setActiveSearchSession:t=>{e({activeSearchSession:t})},startPriceSearch:async r=>{let{items:s}=t();if(0===s.length)throw Error("No items to search");e({isSearching:!0});try{let t=s.map(e=>({product_name:e.product_name,model_number:e.model_number})),a=await S.h.startPriceSearch(t,r),n={id:a.session_id,trace_id:a.trace_id,status:"running",country:r,started_at:new Date().toISOString()};return e({activeSearchSession:n}),{sessionId:a.session_id,traceId:a.trace_id}}catch(t){throw e({isSearching:!1}),t}},markSearchComplete:(t,r)=>{e(e=>({isSearching:!1,activeSearchSession:e.activeSearchSession?{...e.activeSearchSession,status:t,completed_at:new Date().toISOString(),error:r}:null}))}}),"getStorage"in(a={name:B,storage:W(()=>localStorage),partialize:e=>({items:e.items})})||"serialize"in a||"deserialize"in a?(console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),(e,t,r)=>{let n,o,l={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...a},i=!1,c=new Set,d=new Set;try{n=l.getStorage()}catch(e){}if(!n)return s((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${l.name}', the given storage is currently unavailable.`),e(...t)},t,r);let u=R(l.serialize),h=()=>{let e;let r=u({state:l.partialize({...t()}),version:l.version}).then(e=>n.setItem(l.name,e)).catch(t=>{e=t});if(e)throw e;return r},m=r.setState;r.setState=(e,t)=>{m(e,t),h()};let g=s((...t)=>{e(...t),h()},t,r),x=()=>{var r;if(!n)return;i=!1,c.forEach(e=>e(t()));let s=(null==(r=l.onRehydrateStorage)?void 0:r.call(l,t()))||void 0;return R(n.getItem.bind(n))(l.name).then(e=>{if(e)return l.deserialize(e)}).then(e=>{if(e){if("number"!=typeof e.version||e.version===l.version)return e.state;if(l.migrate)return l.migrate(e.state,e.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}}).then(r=>{var s;return e(o=l.merge(r,null!=(s=t())?s:g),!0),h()}).then(()=>{null==s||s(o,void 0),i=!0,d.forEach(e=>e(o))}).catch(e=>{null==s||s(void 0,e)})};return r.persist={setOptions:e=>{l={...l,...e},e.getStorage&&(n=e.getStorage())},clearStorage:()=>{null==n||n.removeItem(l.name)},getOptions:()=>l,rehydrate:()=>x(),hasHydrated:()=>i,onHydrate:e=>(c.add(e),()=>{c.delete(e)}),onFinishHydration:e=>(d.add(e),()=>{d.delete(e)})},x(),o||g}):(e,t,r)=>{let n,o={storage:W(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...a},l=!1,i=new Set,c=new Set,d=o.storage;if(!d)return s((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),e(...t)},t,r);let u=()=>{let e=o.partialize({...t()});return d.setItem(o.name,{state:e,version:o.version})},h=r.setState;r.setState=(e,t)=>{h(e,t),u()};let m=s((...t)=>{e(...t),u()},t,r);r.getInitialState=()=>m;let g=()=>{var r,s;if(!d)return;l=!1,i.forEach(e=>{var r;return e(null!=(r=t())?r:m)});let a=(null==(s=o.onRehydrateStorage)?void 0:s.call(o,null!=(r=t())?r:m))||void 0;return R(d.getItem.bind(d))(o.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===o.version)return[!1,e.state];if(o.migrate)return[!0,o.migrate(e.state,e.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(r=>{var s;let[a,l]=r;if(e(n=o.merge(l,null!=(s=t())?s:m),!0),a)return u()}).then(()=>{null==a||a(n,void 0),n=t(),l=!0,c.forEach(e=>e(n))}).catch(e=>{null==a||a(void 0,e)})};return r.persist={setOptions:e=>{o={...o,...e},e.storage&&(d=e.storage)},clearStorage:()=>{null==d||d.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>g(),hasHydrated:()=>l,onHydrate:e=>(i.add(e),()=>{i.delete(e)}),onFinishHydration:e=>(c.add(e),()=>{c.delete(e)})},o.skipHydration||g(),n||m}));function H(e){let{item:t,onRemove:r,onEdit:s}=e;return(0,n.jsxs)("div",{className:"flex items-start justify-between p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 transition-colors group shadow-soft",children:[(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("h3",{className:"text-gray-800 font-medium truncate",children:t.product_name}),"discovery"===t.source&&(0,n.jsx)("span",{className:"px-2 py-0.5 text-xs bg-indigo-50 text-indigo-600 rounded-full",children:"AI"})]}),t.model_number&&(0,n.jsx)("p",{className:"text-sm text-gray-500 mt-0.5",children:t.model_number}),t.specs_summary&&(0,n.jsx)("p",{className:"text-xs text-gray-400 mt-1 line-clamp-1",children:t.specs_summary}),(0,n.jsxs)("p",{className:"text-xs text-gray-400 mt-2",children:["Added ",function(e){let t=new Date(e).getTime(),r=Date.now()-t,s=Math.floor(r/6e4),a=Math.floor(r/36e5),n=Math.floor(r/864e5);return s<1?"Just now":s<60?"".concat(s,"m ago"):a<24?"".concat(a,"h ago"):n<7?"".concat(n,"d ago"):new Date(t).toLocaleDateString()}(t.added_at)]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[s&&(0,n.jsx)("button",{onClick:()=>s(t.id),className:"p-2 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),(0,n.jsx)("button",{onClick:()=>r(t.id),className:"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"Remove from list",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})}function U(e){let{onSwitchToDiscover:t,onSearchStarted:r,country:s}=e,{items:a,removeItem:l,clearList:i,addItem:c,startPriceSearch:d,isSearching:u}=A(),[h,m]=(0,o.useState)(!1),[g,x]=(0,o.useState)(""),[p,f]=(0,o.useState)(""),[y,v]=(0,o.useState)(null),b=(0,o.useCallback)(e=>{e.preventDefault(),g.trim()&&(c({product_name:g.trim(),model_number:p.trim()||void 0,source:"manual"}),x(""),f(""),m(!1))},[g,p,c]),j=(0,o.useCallback)(()=>{window.confirm("Are you sure you want to clear your entire shopping list?")&&i()},[i]),N=(0,o.useCallback)(async()=>{v(null);try{await d(s),null==r||r()}catch(e){v(e instanceof Error?e.message:"Failed to start search")}},[d,s,r]);return(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-800",children:"Shopping List"}),(0,n.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:0===a.length?"Add products to compare prices":"".concat(a.length," item").concat(1!==a.length?"s":""," in your list")})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)("button",{onClick:()=>m(!h),className:"px-3 py-1.5 text-sm bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors flex items-center gap-1",children:[(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Add Manually"]}),a.length>0&&(0,n.jsx)("button",{onClick:j,className:"px-3 py-1.5 text-sm text-gray-400 hover:text-red-400 transition-colors",children:"Clear All"})]})]}),h&&(0,n.jsxs)("form",{onSubmit:b,className:"mt-4 p-4 bg-gray-50 rounded-lg space-y-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm text-gray-500 mb-1",children:"Product Name *"}),(0,n.jsx)("input",{type:"text",value:g,onChange:e=>x(e.target.value),placeholder:"e.g., Samsung Refrigerator",className:"w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-500 transition-colors",autoFocus:!0})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm text-gray-500 mb-1",children:"Model Number (optional)"}),(0,n.jsx)("input",{type:"text",value:p,onChange:e=>f(e.target.value),placeholder:"e.g., RF72DG9620B1",className:"w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-500 transition-colors"})]}),(0,n.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,n.jsx)("button",{type:"button",onClick:()=>m(!1),className:"px-3 py-1.5 text-sm text-gray-500 hover:text-gray-800 transition-colors",children:"Cancel"}),(0,n.jsx)("button",{type:"submit",disabled:!g.trim(),className:"px-4 py-1.5 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-400 disabled:bg-gray-200 disabled:text-gray-400 transition-colors",children:"Add to List"})]})]})]}),0===a.length?(0,n.jsxs)("div",{className:"bg-white/30 border border-gray-200 rounded-xl p-12 text-center",children:[(0,n.jsx)("svg",{className:"w-16 h-16 mx-auto text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,n.jsx)("p",{className:"text-gray-500 mb-2",children:"Your shopping list is empty"}),(0,n.jsx)("p",{className:"text-gray-400 text-sm mb-4",children:'Use "Find Products" to discover products with AI, or add items manually'}),(0,n.jsx)("button",{onClick:t,className:"px-4 py-2 bg-cyan-500/20 text-indigo-600 hover:bg-cyan-500 hover:text-gray-800 rounded-lg transition-colors text-sm",children:"Find Products with AI"})]}):(0,n.jsxs)("div",{className:"space-y-3",children:[a.map(e=>(0,n.jsx)(H,{item:e,onRemove:l},e.id)),(0,n.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[y&&(0,n.jsx)("div",{className:"mb-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:y}),(0,n.jsx)("button",{onClick:N,disabled:u,className:"w-full py-3 bg-gradient-to-r from-indigo-500 to-blue-500\n                       text-white font-medium rounded-xl\n                       flex items-center justify-center gap-2 transition-all\n                       ".concat(u?"opacity-75 cursor-wait":"hover:from-indigo-400 hover:to-blue-400"),children:u?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("svg",{className:"w-5 h-5 animate-spin",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Searching prices..."]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),"Search Prices for All Items"]})}),(0,n.jsx)("p",{className:"text-center text-gray-400 text-xs mt-2",children:u?"You can continue browsing while we search":"We'll search all your items at once and notify you when done"})]})]})]})}function J(e){let{onViewResults:t}=e,{activeSearchSession:r,isSearching:s}=A(),[a,l]=(0,o.useState)(!1),[i,c]=(0,o.useState)(!1);if((0,o.useEffect)(()=>{if((null==r?void 0:r.status)==="completed"&&!s){l(!0),c(!0);let e=setTimeout(()=>{l(!1)},1e4);return()=>clearTimeout(e)}},[null==r?void 0:r.status,s]),s&&r)return(0,n.jsx)("div",{className:"fixed bottom-20 right-4 z-50 animate-slide-in",children:(0,n.jsx)("div",{className:"bg-white border border-gray-200 rounded-xl shadow-lg p-4 max-w-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsxs)("svg",{className:"w-5 h-5 text-indigo-500 animate-spin",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]})}),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsx)("p",{className:"text-gray-800 text-sm font-medium",children:"Searching prices..."}),(0,n.jsx)("p",{className:"text-gray-500 text-xs truncate",children:"You can continue browsing while we search"})]})]})})});if(!a||!r)return null;let d="completed"===r.status,u="failed"===r.status;return(0,n.jsx)("div",{className:"fixed bottom-20 right-4 z-50 animate-slide-in",children:(0,n.jsxs)("div",{className:"bg-white border rounded-xl shadow-lg p-4 max-w-sm ".concat(d?"border-emerald-300":u?"border-red-300":"border-gray-200"),children:[(0,n.jsxs)("div",{className:"flex items-start gap-3",children:[(0,n.jsx)("div",{className:"flex-shrink-0 mt-0.5",children:d?(0,n.jsx)("svg",{className:"w-5 h-5 text-emerald-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}):(0,n.jsx)("svg",{className:"w-5 h-5 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsx)("p",{className:"text-sm font-medium ".concat(d?"text-emerald-600":"text-red-600"),children:d?"Price search complete!":"Price search failed"}),d?(0,n.jsx)("p",{className:"text-gray-500 text-xs mt-0.5",children:"Click to view results in the dashboard"}):(0,n.jsx)("p",{className:"text-gray-400 text-xs mt-0.5 line-clamp-2",children:r.error||"An error occurred"})]}),(0,n.jsx)("button",{onClick:()=>l(!1),className:"flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),d&&r.trace_id&&(0,n.jsx)("button",{onClick:()=>{t(r.trace_id),l(!1),c(!1)},className:"mt-3 w-full py-2 bg-emerald-50 text-emerald-600 text-sm rounded-lg hover:bg-emerald-500 hover:text-white transition-colors",children:"View Results"})]})})}let q="priceagent_user_country";function V(e){try{let t={country:e,timestamp:Date.now()};localStorage.setItem(q,JSON.stringify(t))}catch(e){console.error("[Country] Failed to cache:",e)}}function G(e){return e.toLowerCase().replace(/[|]/g," ").replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim()}function $(e){return e.toLowerCase().replace(/[^\w]/g,"")}function Q(){return(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)(Y,{}),children:(0,n.jsx)(Z,{})})}function Y(){return(0,n.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-4xl font-bold bg-gradient-to-r from-indigo-500 via-blue-500 to-teal-500 bg-clip-text text-transparent",children:"Shopping Agent"}),(0,n.jsx)("p",{className:"text-gray-500 mt-4 animate-pulse",children:"Loading..."})]})})}function Z(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),r=()=>{let e=t.get("tab");return"search"===e||"discover"===e||"shopping-list"===e?e:t.get("trace")?"search":"discover"},[s,a]=(0,o.useState)(r),i=r=>{a(r);let s=new URLSearchParams(t.toString());s.set("tab",r),s.delete("trace"),e.push("/?".concat(s.toString()),{scroll:!1}),"discover"===r&&E()};(0,o.useEffect)(()=>{let e=r();e!==s&&a(e)},[t]);let{country:c,setCountry:d}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"IL",[t,r]=(0,o.useState)(e),[s,a]=(0,o.useState)(!0),[n,l]=(0,o.useState)(null),i=(0,o.useCallback)(async()=>{a(!0),l(null);let e=function(){try{let e=localStorage.getItem(q);if(!e)return null;let t=JSON.parse(e);if(Date.now()-t.timestamp<6048e5)return t.country;return localStorage.removeItem(q),null}catch(e){return null}}();if(e){r(e),a(!1);return}try{let e=await S.h.getCountry();r(e.country),V(e.country)}catch(e){console.error("[Country] Detection failed:",e),l("Could not detect country")}finally{a(!1)}},[]);return(0,o.useEffect)(()=>{i()},[i]),{country:t,isLoading:s,error:n,setCountry:(0,o.useCallback)(e=>{r(e),V(e)},[]),refresh:i}}("IL"),{showDashboardLink:u}=function(){let[e,t]=(0,o.useState)(!1),[r,s]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{(async()=>{try{let e=await fetch("".concat("http://localhost:8000","/traces/auth/info")),r=await e.json();t(!r.auth_required)}catch(e){t(!0)}finally{s(!1)}})()},[]),{showDashboardLink:e,isLoading:r}}(),{items:m,addItem:p,activeSearchSession:f,markSearchComplete:y}=A(),{history:C,currentTraceId:L,loadHistory:D,loadFromTrace:M,deleteFromHistory:F,clearResults:E}=I(),[P,T]=(0,o.useState)(""),[W,R]=(0,o.useState)(null),[B,z]=(0,o.useState)(!1),[H,Q]=(0,o.useState)(!1),[Y,Z]=(0,o.useState)([]),[ee,es]=(0,o.useState)([]),[ea,en]=(0,o.useState)([]),[eo,el]=(0,o.useState)(null),[ei,ec]=(0,o.useState)(null),[ed,eu]=(0,o.useState)(0),[eh,em]=(0,o.useState)(null),[eg,ex]=(0,o.useState)(null),[ep,ef]=(0,o.useState)([]),[ey,ev]=(0,o.useState)(!1),[eb,ej]=(0,o.useState)([]),[eN,ew]=(0,o.useState)({}),[eS,ek]=(0,o.useState)({}),[e_,eC]=(0,o.useState)({}),{generateDrafts:eL,isGenerating:eD}=(0,k.z)();(0,o.useEffect)(()=>{ej(v()),D()},[D]),(0,o.useEffect)(()=>{if(!(null==f?void 0:f.trace_id)||"running"!==f.status)return;let e=f.trace_id,t="http://localhost:8000".replace("http://","ws://").replace("https://","wss://"),r=null,s=()=>{r&&(r.close(),r=null)};try{(r=new WebSocket("".concat(t,"/traces/ws"))).onmessage=t=>{try{let a=JSON.parse(t.data);if(a.trace_id!==e)return;if("trace_ended"===a.event_type){var r;if(console.log("[PriceSearch] Trace completed:",e),null===(r=a.data)||void 0===r?void 0:r.error)y("failed",a.data.error);else if(y("completed"),m.length>0){let t=m.map(e=>e.product_name).join(", "),r=b({query:t,timestamp:Date.now(),resultCount:m.length,searchTimeMs:0,traceId:e,status:"completed"});ej(e=>[r,...e.slice(0,49)]),console.log("[PriceSearch] Added to history:",r.id)}s()}}catch(e){}},r.onerror=()=>{console.error("[PriceSearch] WebSocket error"),y("failed","Connection error"),s()}}catch(e){console.error("[PriceSearch] Failed to connect WebSocket:",e)}return s},[null==f?void 0:f.trace_id,null==f?void 0:f.status,y,m]),(0,o.useEffect)(()=>{S.h.getSellers().then(e=>{let t={},r={},s={};e.forEach(e=>{let a=e.whatsapp_number||e.phone_number;a&&(e.domain&&(t[e.domain]=a),r[G(e.seller_name)]=a,s[$(e.seller_name)]=a)}),ew(t),ek(r),eC(s),console.log("[Sellers] Loaded",e.length,"sellers for enrichment")}).catch(e=>{console.error("[Sellers] Failed to load sellers:",e)})},[]),(0,o.useEffect)(()=>{g("/")},[]);let eI=(0,o.useCallback)((e,t)=>{if(t){let e=function(e){try{let t=new URL(e).hostname.toLowerCase();if(t.startsWith("www.")&&(t=t.slice(4)),t.includes("google.com"))return null;return t}catch(e){return null}}(t);if(e&&eN[e])return eN[e]}let r=G(e);if(eS[r])return eS[r];for(let[e,t]of Object.entries(eS))if(r.includes(e)||e.includes(r))return t;let s=$(e);if(e_[s])return e_[s];for(let[e,t]of Object.entries(e_))if(s.includes(e)||e.includes(s))return t},[eN,eS,e_]),eM=(0,o.useCallback)(e=>e.map(e=>({...e,results:e.results.map(e=>{if(e.phone)return e;let t=eI(e.seller,e.url);return t?{...e,phone:t}:e})})),[eI]),eF=(0,o.useCallback)(e=>e.map(e=>{var t,r;if(e.contact)return e;let s=eI(e.storeName,null===(r=e.products)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.url);return s?{...e,contact:s}:e}),[eI]),eE=Object.keys(eN).length>0||Object.keys(eS).length>0;(0,o.useEffect)(()=>{eE&&Y.length>0&&Y.some(e=>e.results.some(e=>!e.phone&&(e.url||e.seller)))&&(console.log("[Enrichment] Re-enriching results with seller data"),Z(e=>eM(e))),eE&&ee.length>0&&ee.some(e=>{var t,r;return!e.contact&&(e.storeName||(null===(r=e.products)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.url))})&&(console.log("[Enrichment] Re-enriching bundles with seller data"),es(e=>eF(e)))},[eE]);let eP=async()=>{ev(!0);try{let e=await fetch("".concat("http://localhost:8000","/traces/?limit=20"));if(e.ok){let t=((await e.json()).traces||[]).filter(e=>"completed"===e.status&&!e.input_prompt.toLowerCase().includes("test"));ef(t)}}catch(e){console.error("[History] Failed to fetch traces:",e)}finally{ev(!1)}};(0,o.useEffect)(()=>{eP()},[]),(0,o.useEffect)(()=>{let e=t.get("trace");e&&e!==W?eT(e):!e&&W&&(R(null),Z([]),es([]),en([]),ex(null),T(""))},[t]);let eT=async t=>{console.log("[LoadTrace] Starting load for trace:",t),Q(!0),el(null),Z([]),es([]),en([]),ex(null);try{var r;let e="http://localhost:8000";console.log("[LoadTrace] Fetching from:","".concat(e,"/traces/").concat(t));let s=await fetch("".concat(e,"/traces/").concat(t));if(!s.ok)throw console.error("[LoadTrace] Response not ok:",s.status),Error("Trace not found");let a=await s.json();if(console.log("[LoadTrace] Got trace:",a.status,"has final_output:",!!a.final_output,"spans:",null===(r=a.spans)||void 0===r?void 0:r.length),"completed"===a.status){T(a.input_prompt.replace("Search for: ","")),R(t),ec(a.total_duration_ms);let e=(a.spans||[]).filter(e=>"tool_call"===e.span_type&&("search_products"===e.tool_name||"search_multiple_products"===e.tool_name||"search_aggregators"===e.tool_name)&&e.tool_output);if(console.log("[LoadTrace] Found search spans:",e.length),e.length>0){let t=[];for(let r of e){let e;let s=r.tool_output;ex(s);let a=/\n=== ([^=\n]+) ===\n/g,n=[];for(;null!==(e=a.exec(s));)e[1].includes("BUNDLE")||n.push({name:e[1].trim(),startIndex:e.index+e[0].length});if(n.length>0)for(let e=0;e<n.length;e++){let r=n[e].startIndex,a=e+1<n.length?s.indexOf("\n===",r):s.length,o=s.slice(r,a>0?a:void 0),l=et(o);l.length>0&&t.push({productName:n[e].name,results:l})}else{let e="Search Results";if(r.tool_input)try{let t="string"==typeof r.tool_input?JSON.parse(r.tool_input):r.tool_input;t.query&&(e=t.query)}catch(e){}let a=et(s);a.length>0&&t.push({productName:e,results:a})}let o=er(s);o.length>0&&(es(eF(o)),console.log("[LoadTrace] Found bundles:",o.length))}Z(eM(t)),console.log("[LoadTrace] Parsed results:",t.length,"products")}else if(a.final_output){ex(a.final_output);let e=X(a.final_output);Z(eM(e)),console.log("[LoadTrace] Parsed from final_output:",e.length)}else el("Search completed but no results found")}else"error"===a.status?el(a.error||"Search failed"):"running"===a.status?el("This search is still running. Please wait..."):(console.log("[LoadTrace] Unknown status:",a.status),el("Could not load results"))}catch(t){console.error("[LoadTrace] Error:",t),el("Could not load search results"),e.replace("/",{scroll:!1})}finally{Q(!1)}},eO=t=>{let r="/?trace=".concat(t);e.replace(r,{scroll:!1}),R(t)};(0,o.useEffect)(()=>{let e=null;return B&&(eu(0),e=setInterval(()=>{eu(e=>e+1)},1e3)),()=>{e&&clearInterval(e)}},[B]);let eW=(e,t)=>new Promise((r,s)=>{let a=t.replace("http://","ws://").replace("https://","wss://")||"".concat("https:"===window.location.protocol?"wss:":"ws:","//").concat(window.location.host),n=new WebSocket("".concat(a,"/traces/ws")),o=!1,l=()=>{n.readyState===WebSocket.OPEN&&n.close()};n.onopen=()=>{em("Connected, waiting for results...")},n.onmessage=async t=>{try{var a,n,i,c,d,u;let h=JSON.parse(t.data);if(h.trace_id!==e)return;if("span_started"===h.event_type||"span_ended"===h.event_type){let e=(null===(a=h.data)||void 0===a?void 0:a.name)||"",t=(null===(n=h.data)||void 0===n?void 0:n.type)||(null===(i=h.data)||void 0===i?void 0:i.span_type)||"",r=e;e.includes("search_products")||e.includes("search_aggregators")?r="\uD83D\uDD0D Searching price comparison sites...":e.includes("google_shopping")||e.includes("GoogleShopping")?r="\uD83D\uDED2 Searching Google Shopping...":e.includes("google_search")||e.includes("GoogleSearch")?r="\uD83D\uDD0E Searching Google...":e.includes("zap")||e.includes("Zap")?r="\uD83C\uDFEA Searching Zap.co.il...":e.includes("wisebuy")||e.includes("WiseBuy")?r="\uD83D\uDCA1 Searching WiseBuy...":e.includes("extract")||e.includes("scrape")?r="\uD83D\uDCC4 Extracting product details...":"llm_call"===t?r="\uD83E\uDD16 AI is analyzing results...":"agent"===t||"agent_run"===t?r="\uD83D\uDD04 Processing...":e&&(r=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())),em(r)}"trace_ended"===h.event_type&&(o=!0,l(),console.log("[WebSocket] trace_ended received:",h),console.log("[WebSocket] final_output:",null===(c=h.data)||void 0===c?void 0:c.final_output),(null===(d=h.data)||void 0===d?void 0:d.error)?s(Error(h.data.error)):r((null===(u=h.data)||void 0===u?void 0:u.final_output)||""))}catch(e){console.error("WebSocket message parse error:",e)}},n.onerror=()=>{o||(l(),s(Error("WebSocket connection failed")))},n.onclose=()=>{o||fetch("".concat(t,"/traces/").concat(e)).then(e=>e.json()).then(e=>{"completed"===e.status?r(e.final_output||""):"error"===e.status?s(Error(e.error||"Search failed")):s(Error("Connection lost. Check the dashboard for results."))}).catch(()=>s(Error("Connection lost. Check the dashboard for results.")))}}),eR=(0,o.useCallback)(async e=>{if(e.preventDefault(),!P.trim()||B)return;z(!0),el(null),Z([]),es([]),en([]),ex(null),em("Starting search...");let t=Date.now();try{let e="http://localhost:8000",a=await fetch("".concat(e,"/agent/run"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agent:"research",query:P})});if(!a.ok)throw Error("Failed to start search. Please try again.");let{trace_id:n}=await a.json(),o=b({query:P,timestamp:Date.now(),resultCount:0,searchTimeMs:0,traceId:n,status:"searching"});ej(e=>[o,...e.filter(e=>e.traceId!==n).slice(0,49)]),await eW(n,e);let l=Date.now()-t;ec(l),em(null),eO(n);let i=await fetch("".concat(e,"/traces/").concat(n));if(i.ok){var r,s;let e=await i.json(),t=(e.spans||[]).filter(e=>"tool_call"===e.span_type&&("search_products"===e.tool_name||"search_multiple_products"===e.tool_name)&&e.tool_output);if(t.length>0){let e=[];for(let r of t){let t;let s=r.tool_output;ex(s);let a=/\n=== ([^=\n]+) ===\n/g,n=[];for(;null!==(t=a.exec(s));)t[1].includes("BUNDLE")||n.push({name:t[1].trim(),startIndex:t.index+t[0].length});if(n.length>0)for(let t=0;t<n.length;t++){let r=n[t].startIndex,a=t+1<n.length?s.indexOf("\n===",r):s.length,o=s.slice(r,a>0?a:void 0),l=et(o);l.length>0&&e.push({productName:n[t].name,results:l})}else{let t=P;if(r.tool_input)try{let e="string"==typeof r.tool_input?JSON.parse(r.tool_input):r.tool_input;e.query&&(t=e.query)}catch(e){}let a=et(s);a.length>0&&e.push({productName:t,results:a})}let o=er(s);o.length>0&&(es(eF(o)),console.log("[Search] Found bundles:",o.length))}Z(eM(e)),console.log("[Search] Parsed from tool output:",e.length,"products");let s=e.reduce((e,t)=>e+t.results.length,0);x(P,s,l),j(n,{status:"completed",resultCount:s,searchTimeMs:l,topResults:null===(r=e[0])||void 0===r?void 0:r.results.slice(0,3).map(e=>({seller:e.seller,price:e.price,currency:e.currency}))}),ej(e=>e.map(e=>e.traceId===n?{...e,status:"completed",resultCount:s,searchTimeMs:l}:e))}else if(e.final_output){ex(e.final_output);let t=X(e.final_output);Z(eM(t));let r=t.reduce((e,t)=>e+t.results.length,0);x(P,r,l),j(n,{status:"completed",resultCount:r,searchTimeMs:l,topResults:null===(s=t[0])||void 0===s?void 0:s.results.slice(0,3).map(e=>({seller:e.seller,price:e.price,currency:e.currency}))}),ej(e=>e.map(e=>e.traceId===n?{...e,status:"completed",resultCount:r,searchTimeMs:l}:e))}}}catch(e){el(e instanceof Error?e.message:"An error occurred"),em(null)}finally{z(!1)}},[P,B]),eB=async t=>{if(console.log("[LocalHistory] Clicked item:",t.id,t.query,"traceId:",t.traceId),a("search"),T(t.query),t.traceId){let r=new URLSearchParams;r.set("tab","search"),r.set("trace",t.traceId),e.push("/?".concat(r.toString()),{scroll:!1}),eT(t.traceId);return}let r=ep.find(e=>e.input_prompt.includes(t.query)||t.query.includes(e.input_prompt.replace("Search for: ","")));if(!r)try{let e=await fetch("".concat("http://localhost:8000","/traces/?limit=50"));e.ok&&(r=((await e.json()).traces||[]).find(e=>"completed"===e.status&&(e.input_prompt.includes(t.query)||t.query.includes(e.input_prompt.replace("Search for: ","")))))}catch(e){console.error("[LocalHistory] Failed to search traces:",e)}if(r){console.log("[LocalHistory] Found matching trace:",r.id);let t=new URLSearchParams;t.set("tab","search"),t.set("trace",r.id),e.push("/?".concat(t.toString()),{scroll:!1}),eT(r.id)}else i("search"),console.log("[LocalHistory] No matching trace found for query:",t.query)},ez=t=>{if(console.log("[DiscoveryHistory] Clicked item:",t.id,t.query,"traceId:",t.traceId),t.traceId){let r=new URLSearchParams;r.set("tab","discover"),r.set("trace",t.traceId),e.push("/?".concat(r.toString()),{scroll:!1}),M(t.traceId,t.query)}else i("discover")},eA=e=>{en(t=>t.find(t=>t.id===e.id)?t.filter(t=>t.id!==e.id):[...t,e])},eH=e=>ea.some(t=>t.id===e),eU=(e,t)=>{h("contact","whatsapp",{label:e,data:{product:P}});let r=t.replace(/[^0-9+]/g,""),s=encodeURIComponent("Hi, I'm interested in ".concat(P,". What's your best price?"));window.open("https://wa.me/".concat(r,"?text=").concat(s),"_blank")},eJ=(0,o.useCallback)(e=>{console.log("[ShoppingList] Added item:",p(e).product_name)},[p]);return(0,n.jsxs)("div",{className:"min-h-screen bg-gray-50 flex flex-col md:flex-row",children:[(0,n.jsx)("header",{className:"md:hidden bg-white border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 z-50",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)("svg",{className:"w-8 h-8",viewBox:"0 0 64 64",fill:"none",children:[(0,n.jsx)("path",{d:"M12 20 L8 58 C8 60 10 62 12 62 L52 62 C54 62 56 60 56 58 L52 20 Z",fill:"#818CF8",stroke:"#6366f1",strokeWidth:"2"}),(0,n.jsx)("path",{d:"M22 20 C22 12 26 6 32 6 C38 6 42 12 42 20",fill:"none",stroke:"#6366f1",strokeWidth:"3",strokeLinecap:"round"}),(0,n.jsx)("circle",{cx:"24",cy:"36",r:"4",fill:"#34D399"}),(0,n.jsx)("circle",{cx:"40",cy:"36",r:"4",fill:"#34D399"}),(0,n.jsx)("path",{d:"M24 46 Q32 52 40 46",fill:"none",stroke:"#34D399",strokeWidth:"2",strokeLinecap:"round"})]}),(0,n.jsx)("h1",{className:"text-lg font-bold text-gray-800",children:"Shopping Agent"})]})}),(0,n.jsxs)("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex z-50",children:[(0,n.jsxs)("button",{onClick:()=>i("discover"),className:"flex-1 flex flex-col items-center py-3 ".concat("discover"===s?"text-indigo-600":"text-gray-500"),children:[(0,n.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,n.jsx)("span",{className:"text-xs mt-1",children:"Find"})]}),(0,n.jsxs)("button",{onClick:()=>i("search"),className:"flex-1 flex flex-col items-center py-3 ".concat("search"===s?"text-indigo-600":"text-gray-500"),children:[(0,n.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,n.jsx)("span",{className:"text-xs mt-1",children:"Prices"})]}),(0,n.jsxs)("button",{onClick:()=>i("shopping-list"),className:"flex-1 flex flex-col items-center py-3 relative ".concat("shopping-list"===s?"text-indigo-600":"text-gray-500"),children:[(0,n.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,n.jsx)("span",{className:"text-xs mt-1",children:"List"}),m.length>0&&(0,n.jsx)("span",{className:"absolute top-1 right-1/4 w-5 h-5 text-xs bg-indigo-500 text-gray-800 rounded-full flex items-center justify-center",children:m.length})]})]}),(0,n.jsxs)("aside",{className:"hidden md:flex fixed top-0 left-0 h-full w-64 bg-white border-r border-gray-200 flex-col z-40 shadow-soft",children:[(0,n.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3 mb-3",children:[(0,n.jsx)("div",{className:"w-10 h-10 flex items-center justify-center",children:(0,n.jsxs)("svg",{className:"w-10 h-10",viewBox:"0 0 64 64",fill:"none",children:[(0,n.jsx)("path",{d:"M12 20 L8 58 C8 60 10 62 12 62 L52 62 C54 62 56 60 56 58 L52 20 Z",fill:"#818CF8",stroke:"#6366f1",strokeWidth:"2"}),(0,n.jsx)("path",{d:"M22 20 C22 12 26 6 32 6 C38 6 42 12 42 20",fill:"none",stroke:"#6366f1",strokeWidth:"3",strokeLinecap:"round"}),(0,n.jsx)("circle",{cx:"24",cy:"36",r:"5",fill:"#34D399"}),(0,n.jsx)("circle",{cx:"24",cy:"36",r:"2",fill:"#059669"}),(0,n.jsx)("circle",{cx:"40",cy:"36",r:"5",fill:"#34D399"}),(0,n.jsx)("circle",{cx:"40",cy:"36",r:"2",fill:"#059669"}),(0,n.jsx)("path",{d:"M24 46 Q32 54 40 46",fill:"none",stroke:"#34D399",strokeWidth:"2.5",strokeLinecap:"round"}),(0,n.jsx)("circle",{cx:"32",cy:"4",r:"3",fill:"#34D399"}),(0,n.jsx)("line",{x1:"32",y1:"6",x2:"32",y2:"12",stroke:"#34D399",strokeWidth:"2"})]})}),(0,n.jsx)("div",{children:(0,n.jsx)("h1",{className:"text-lg font-bold text-gray-800",children:"Shopping Agent"})})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[(0,n.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor",children:(0,n.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"})}),(0,n.jsx)("span",{children:"Built by Yonigo"})]})]}),(0,n.jsxs)("nav",{className:"p-3 space-y-1 border-b border-gray-200",children:[(0,n.jsxs)("button",{onClick:()=>i("discover"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("discover"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,n.jsx)("span",{className:"font-medium",children:"Find Products"})]}),(0,n.jsxs)("button",{onClick:()=>i("search"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("search"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,n.jsx)("span",{className:"font-medium",children:"Price Search"})]}),(0,n.jsxs)("button",{onClick:()=>i("shopping-list"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("shopping-list"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),(0,n.jsx)("span",{className:"font-medium",children:"Shopping List"}),m.length>0&&(0,n.jsx)("span",{className:"ml-auto w-5 h-5 text-xs flex items-center justify-center rounded-full ".concat("shopping-list"===s?"bg-indigo-200 text-indigo-700":"bg-indigo-100 text-indigo-600"),children:m.length})]})]}),(0,n.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,n.jsxs)("div",{className:"p-3",children:[(0,n.jsx)("h3",{className:"text-xs font-medium text-gray-400 uppercase tracking-wider mb-2",children:"discover"===s?"Discovery History":"search"===s?"Search History":"Recent Searches"}),ey?(0,n.jsx)("div",{className:"text-center text-gray-400 py-4",children:(0,n.jsx)("p",{className:"animate-pulse text-sm",children:"Loading..."})}):"search"===s?0===eb.length?(0,n.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,n.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,n.jsx)("p",{className:"text-xs",children:"No search history"})]}):(0,n.jsx)("div",{className:"space-y-1",children:eb.slice(0,10).map(e=>{let t=e.traceId===W;return(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsxs)("button",{onClick:()=>eB(e),className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":"hover:bg-white"),children:[(0,n.jsx)("p",{className:"text-sm truncate pr-6 ".concat(t?"text-indigo-700 font-medium":"text-gray-800"),children:e.query}),(0,n.jsx)("p",{className:"text-xs text-gray-400",children:w(e.timestamp)})]}),(0,n.jsx)("button",{"data-testid":"delete-history-item",onClick:t=>{t.stopPropagation(),N(e.id),ej(t=>t.filter(t=>t.id!==e.id))},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})}):"discover"===s?0===C.length?(0,n.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,n.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,n.jsx)("p",{className:"text-xs",children:"No discovery history"})]}):(0,n.jsx)("div",{className:"space-y-1",children:C.slice(0,10).map(e=>{let t=e.traceId===L,r="searching"===e.status,s="error"===e.status;return(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsxs)("button",{onClick:()=>!r&&ez(e),disabled:r,className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":r?"bg-amber-50 border border-amber-200":s?"bg-red-50 border border-red-200":"hover:bg-white"," ").concat(r?"cursor-wait":""),children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[r&&(0,n.jsxs)("svg",{className:"w-3 h-3 animate-spin text-amber-500 flex-shrink-0",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"completed"===e.status&&(0,n.jsx)("svg",{className:"w-3 h-3 text-emerald-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),s&&(0,n.jsx)("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,n.jsx)("p",{className:"text-sm truncate pr-6 ".concat(t?"text-indigo-700 font-medium":r?"text-amber-700":s?"text-red-700":"text-gray-800"),children:e.query})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400 ml-5",children:[(0,n.jsx)("span",{children:w(e.timestamp)}),r&&(0,n.jsx)("span",{className:"text-amber-500",children:"Searching..."}),"completed"===e.status&&e.productCount>0&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:"-"}),(0,n.jsxs)("span",{children:[e.productCount," products"]})]}),s&&(0,n.jsx)("span",{className:"text-red-500",children:"Failed"})]})]}),!r&&(0,n.jsx)("button",{onClick:t=>{t.stopPropagation(),F(e.id)},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})}):0===eb.length?(0,n.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,n.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,n.jsx)("p",{className:"text-xs",children:"No recent price searches"})]}):(0,n.jsx)("div",{className:"space-y-1",children:eb.slice(0,5).map(e=>{let t=e.traceId===W,r="searching"===e.status,s="error"===e.status;return(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsxs)("button",{onClick:()=>!r&&eB(e),disabled:r,className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":r?"bg-amber-50 border border-amber-200":s?"bg-red-50 border border-red-200":"hover:bg-white"," ").concat(r?"cursor-wait":""),children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[r&&(0,n.jsxs)("svg",{className:"w-3 h-3 animate-spin text-amber-500 flex-shrink-0",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"completed"===e.status&&(0,n.jsx)("svg",{className:"w-3 h-3 text-emerald-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),s&&(0,n.jsx)("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,n.jsx)("p",{className:"text-sm truncate ".concat(t?"text-indigo-700 font-medium":r?"text-amber-700":s?"text-red-700":"text-gray-800"),children:e.query})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400 ml-5",children:[(0,n.jsx)("span",{children:w(e.timestamp)}),r&&(0,n.jsx)("span",{className:"text-amber-500",children:"Searching..."}),"completed"===e.status&&e.resultCount>0&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:"-"}),(0,n.jsxs)("span",{children:[e.resultCount," results"]})]}),s&&(0,n.jsx)("span",{className:"text-red-500",children:"Failed"})]})]}),!r&&(0,n.jsx)("button",{onClick:t=>{t.stopPropagation(),N(e.id),ej(t=>t.filter(t=>t.id!==e.id))},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})})]})}),u&&(0,n.jsx)("div",{className:"p-3 border-t border-gray-200",children:(0,n.jsxs)("a",{href:"/dashboard",className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-500 hover:text-gray-800 hover:bg-white rounded-lg transition-colors",children:[(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),"Dashboard"]})})]}),(0,n.jsxs)("main",{className:"flex-1 md:ml-64 min-h-screen pb-20 md:pb-0",children:["search"===s&&(0,n.jsx)("div",{className:"p-4 md:p-8",children:(0,n.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,n.jsxs)("form",{onSubmit:eR,className:"relative",children:[(0,n.jsxs)("div",{className:"relative group",children:[(0,n.jsx)("input",{type:"text",value:P,onChange:e=>T(e.target.value),placeholder:"Search for products (e.g., Samsung refrigerator RF72DG9620B1)",className:"w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg bg-white shadow-soft border border-gray-200 rounded-xl md:rounded-2xl text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 transition-all duration-300",disabled:B}),(0,n.jsx)("button",{type:"submit",disabled:B||!P.trim(),className:"absolute right-2 top-1/2 -translate-y-1/2 px-4 md:px-6 py-2 bg-indigo-500 hover:bg-indigo-600 disabled:bg-gray-300 text-white font-medium rounded-lg md:rounded-xl transition-all duration-300",children:B?(0,n.jsxs)("span",{className:"flex items-center gap-2",children:[(0,n.jsxs)("svg",{className:"animate-spin h-5 w-5",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Searching..."]}):"Search"})]}),(B||H)&&(0,n.jsxs)("div",{className:"text-center mt-4 space-y-2",children:[(0,n.jsx)("div",{className:"text-gray-500 text-sm animate-pulse",children:H?"Loading results...":eh||"Starting search..."}),B&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"text-gray-400 text-xs",children:["Elapsed: ",Math.floor(ed/60),":",(ed%60).toString().padStart(2,"0")]}),ed>30&&(0,n.jsx)("div",{className:"text-gray-300 text-xs",children:"Searching multiple sources - this may take a minute"})]})]})]}),0===Y.length&&!B&&!H&&!eo&&!eg&&(0,n.jsx)("div",{className:"flex flex-wrap justify-center gap-2 mt-6",children:["Samsung refrigerator","LG washing machine","Bosch oven","Apple iPhone 15"].map(e=>(0,n.jsx)("button",{onClick:()=>T(e),className:"px-4 py-2 text-sm text-gray-500 bg-white shadow-soft rounded-full hover:bg-gray-100 hover:text-gray-800 transition-colors",children:e},e))}),0===Y.length&&!B&&!H&&!eo&&!eg&&eb.length>0&&(0,n.jsxs)("div",{className:"mt-8",children:[(0,n.jsx)("h3",{className:"text-sm text-gray-400 text-center mb-3",children:"Recent searches"}),(0,n.jsx)("div",{className:"flex flex-wrap justify-center gap-2",children:eb.slice(0,5).map(e=>(0,n.jsxs)("button",{onClick:()=>eB(e),className:"px-3 py-1.5 text-sm text-gray-400 bg-white/30 rounded-lg hover:bg-white hover:text-gray-600 transition-colors flex items-center gap-2",children:[(0,n.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.query]},e.id))})]}),(Y.length>0||eo||eg&&!B)&&(0,n.jsx)("div",{className:"mt-8",children:eo?(0,n.jsxs)("div",{className:"text-center py-12",children:[(0,n.jsx)("div",{className:"text-red-400 text-lg",children:eo}),(0,n.jsx)("button",{onClick:()=>el(null),className:"mt-4 text-indigo-600 hover:underline",children:"Try again"})]}):Y.length>0?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,n.jsxs)("div",{className:"text-gray-500",children:["Found ",Y.reduce((e,t)=>e+t.results.length,0)," results",ee.length>0&&" from ".concat(ee.length," bundle stores"),ei&&(0,n.jsxs)("span",{className:"text-gray-300",children:[" in ",(ei/1e3).toFixed(1),"s"]})]}),u&&(0,n.jsx)("a",{href:"/dashboard",className:"text-sm text-indigo-600 hover:underline",children:"Advanced view →"})]}),ee.length>0&&(0,n.jsxs)("div",{className:"mb-8 bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-4",children:[(0,n.jsxs)("h3",{className:"text-lg font-semibold text-amber-600 mb-4 flex items-center gap-2",children:[(0,n.jsx)("span",{children:"Bundle Opportunities"}),(0,n.jsx)("span",{className:"text-sm font-normal text-amber-600/70",children:"- Stores with multiple products"})]}),(0,n.jsx)("div",{className:"overflow-x-auto",children:(0,n.jsxs)("table",{className:"w-full text-sm",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{className:"text-left text-gray-500 border-b border-gray-200",children:[(0,n.jsx)("th",{className:"pb-3 font-medium w-10",children:"Select"}),(0,n.jsx)("th",{className:"pb-3 font-medium",children:"Store"}),(0,n.jsx)("th",{className:"pb-3 font-medium",children:"Rating"}),(0,n.jsx)("th",{className:"pb-3 font-medium",children:"Products"}),(0,n.jsx)("th",{className:"pb-3 font-medium",children:"Total"}),(0,n.jsx)("th",{className:"pb-3 font-medium",children:"Contact"})]})}),(0,n.jsx)("tbody",{children:ee.map((e,t)=>{let r="bundle-".concat(e.storeName,"-").concat(t),s=eH(r),a=!!e.contact;return(0,n.jsxs)("tr",{className:"border-b border-gray-200/50 ".concat(s?"bg-indigo-500/10":""),children:[(0,n.jsx)("td",{className:"py-3",children:a?(0,n.jsx)("button",{onClick:()=>eA({id:r,name:e.storeName,phone:e.contact,price:e.totalPrice,productName:"Bundle (".concat(e.productCount," items)")}),className:"w-5 h-5 flex items-center justify-center rounded border-2 transition-colors\n                                              ".concat(s?"bg-indigo-500 border-indigo-500 text-white":"border-gray-300 hover:border-indigo-400"),children:s&&(0,n.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):(0,n.jsx)("span",{className:"text-gray-400",children:t+1})}),(0,n.jsx)("td",{className:"py-3 text-gray-800 font-medium",children:e.storeName}),(0,n.jsx)("td",{className:"py-3",children:e.rating?(0,n.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 bg-amber-50 text-amber-600 rounded text-xs",children:["★ ",e.rating.toFixed(1)]}):"-"}),(0,n.jsx)("td",{className:"py-3",children:(0,n.jsxs)("div",{className:"space-y-1",children:[e.products.map((e,t)=>(0,n.jsxs)("div",{className:"text-xs text-gray-500",children:[e.name,": ",e.url?(0,n.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-indigo-600 hover:underline",children:["₪",e.price.toLocaleString()]}):(0,n.jsxs)("span",{className:"text-emerald-600",children:["₪",e.price.toLocaleString()]})]},t)),(0,n.jsx)("div",{className:"text-xs text-amber-600/70 italic mt-1",children:"Ask for bundle discount"})]})}),(0,n.jsxs)("td",{className:"py-3",children:[(0,n.jsxs)("div",{className:"text-emerald-600 font-bold",children:["₪",e.totalPrice.toLocaleString()]}),(0,n.jsxs)("div",{className:"text-xs text-gray-400",children:[e.productCount,"/",e.totalProducts," products"]})]}),(0,n.jsx)("td",{className:"py-3",children:e.contact?(0,n.jsxs)("button",{onClick:()=>eU(e.storeName,e.contact),className:"flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500/20 text-emerald-600 hover:bg-emerald-500 hover:text-gray-800 rounded-lg transition-colors text-xs",children:[(0,n.jsx)("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact"]}):(0,n.jsx)("span",{className:"text-gray-400 text-xs",children:"-"})})]},t)})})]})})]}),Y.map((e,t)=>(0,n.jsxs)("div",{className:"mb-8",children:[Y.length>1&&(0,n.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-4",children:e.productName}),(0,n.jsx)("div",{className:"space-y-3",children:e.results.map((t,r)=>{let s="".concat(e.productName,"-").concat(t.seller,"-").concat(r);return(0,n.jsx)(K,{result:t,rank:r+1,productName:e.productName,isSelected:eH(s),onToggleSelect:()=>t.phone&&eA({id:s,name:t.seller,phone:t.phone,price:t.price,productName:e.productName}),onContact:()=>t.phone&&eU(t.seller,t.phone)},r)})})]},t))]}):eg?(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"text-gray-500",children:["Search completed",ei&&(0,n.jsxs)("span",{className:"text-gray-300",children:[" in ",(ei/1e3).toFixed(1),"s"]})]}),u&&(0,n.jsx)("a",{href:"/dashboard",className:"text-sm text-indigo-600 hover:underline",children:"View in dashboard →"})]}),(0,n.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-4",children:[(0,n.jsx)("h3",{className:"text-gray-800 font-medium mb-3",children:"Agent Response"}),(0,n.jsx)("pre",{className:"text-gray-600 text-sm whitespace-pre-wrap font-mono overflow-x-auto",children:eg})]}),(0,n.jsx)("p",{className:"text-gray-400 text-sm text-center",children:"Results displayed in raw format. View the dashboard for structured data."})]}):null})]})}),"discover"===s&&(0,n.jsx)("div",{className:"p-8",children:(0,n.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,n.jsx)(O,{onAddToShoppingList:eJ,country:c,onCountryChange:d})})}),"shopping-list"===s&&(0,n.jsx)("div",{className:"p-8",children:(0,n.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,n.jsx)(U,{onSwitchToDiscover:()=>i("discover"),onSearchStarted:()=>i("search"),country:c})})})]}),ea.length>0&&(0,n.jsxs)("div",{className:"fixed bottom-16 left-1/2 -translate-x-1/2 z-40 bg-white border border-gray-200 rounded-2xl shadow-2xl px-6 py-3 flex items-center gap-4",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 text-gray-800",children:[(0,n.jsx)("span",{className:"w-8 h-8 flex items-center justify-center bg-indigo-500 text-white rounded-full text-sm font-bold",children:ea.length}),(0,n.jsxs)("span",{className:"text-gray-600",children:[1===ea.length?"seller":"sellers"," selected"]})]}),(0,n.jsx)("div",{className:"w-px h-8 bg-gray-200"}),(0,n.jsx)("button",{onClick:()=>{0!==ea.length&&eL(ea.map(e=>({seller_name:e.name,phone_number:e.phone,product_name:e.productName||P,listed_price:e.price||0})))},disabled:eD,className:"flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-400 disabled:bg-emerald-500/50 disabled:cursor-wait text-gray-800 font-medium rounded-xl transition-colors",children:eD?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("svg",{className:"w-5 h-5 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Generating Messages..."]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact Sellers"]})}),(0,n.jsx)("button",{onClick:()=>{en([])},className:"p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",title:"Clear selection",children:(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,n.jsx)("footer",{className:"fixed bottom-0 left-64 right-0 py-3 text-center text-xs text-gray-300",children:(0,n.jsx)("span",{children:"Powered by Claude AI"})}),(0,n.jsx)(_.T,{}),(0,n.jsx)(J,{onViewResults:t=>{a("search");let r=new URLSearchParams;r.set("tab","search"),r.set("trace",t),e.push("/?".concat(r.toString()),{scroll:!1}),eT(t)}})]})}function K(e){var t,r;let{result:s,rank:a,productName:o,isSelected:l,onToggleSelect:i,onContact:c}=e,d=!!s.phone;return(0,n.jsx)("div",{className:"group bg-white shadow-soft border rounded-xl p-4 transition-all duration-300\n                    ".concat(l?"border-cyan-500 bg-indigo-500/10":"border-gray-200/50 hover:border-cyan-500/30 hover:bg-white/70"),children:(0,n.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[d?(0,n.jsx)("button",{onClick:i,className:"flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-md border-2 transition-colors\n                          ".concat(l?"bg-indigo-500 border-indigo-500 text-white":"border-gray-300 hover:border-indigo-400"),children:l&&(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):(0,n.jsx)("span",{className:"flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-xs text-gray-500",children:a}),(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("h3",{className:"font-medium text-gray-800 truncate",children:o}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[(0,n.jsx)("span",{children:s.seller}),s.rating&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{className:"text-gray-300",children:"•"}),(0,n.jsx)("span",{className:"text-amber-600",children:"★"}),(0,n.jsx)("span",{children:s.rating.toFixed(1)})]})]})]})]}),s.source&&(0,n.jsxs)("span",{className:"inline-block mt-2 px-2 py-0.5 text-xs text-gray-400 bg-gray-100/50 rounded",children:["via ",s.source]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("div",{className:"text-right",children:(0,n.jsx)("div",{className:"text-2xl font-bold text-emerald-600",children:(t=s.price,"ILS"===(r=s.currency)?"₪".concat(t.toLocaleString()):"".concat(r," ").concat(t.toLocaleString()))})}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[s.url&&(0,n.jsx)("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",title:"View product",children:(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})}),s.phone&&(0,n.jsxs)("button",{onClick:c,className:"flex items-center gap-2 px-4 py-2 bg-emerald-500/20 text-emerald-600 hover:bg-emerald-500 hover:text-gray-800 rounded-lg transition-all duration-300",children:[(0,n.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact"]})]})]})]})})}function X(e){let t;let r=[];console.log("[Parser] Parsing text:",e.substring(0,500));let s=/\n=== ([^=\n]+) ===\n/g,a=[];for(;null!==(t=s.exec(e));)t[1].includes("BUNDLE")||a.push({name:t[1].trim(),startIndex:t.index+t[0].length});if(a.length>0)for(let t=0;t<a.length;t++){let s=a[t].startIndex,n=t+1<a.length?e.indexOf("\n===",s):e.length,o=ee(e.slice(s,n>0?n:void 0));o.length>0&&r.push({productName:a[t].name,results:o})}else{let t=ee(e);t.length>0&&r.push({productName:"Search Results",results:t})}return console.log("[Parser] Parsed results:",r.length,"products"),r}function ee(e){let t=[],r=e.split("\n");console.log("[Parser] Parsing section with",r.length,"lines");for(let e=0;e<r.length;e++){let s=r[e].trim().match(/^(\d+)\.\s+(.+)/);if(s){let a,n,o,l;let i=s[2];console.log("[Parser] Found numbered line:",s[1],"-",i);let c=i,d=i.match(/\[([^\]]+)\]\s*$/);d&&(n=d[1],c=i.slice(0,i.lastIndexOf("[")).trim());let u=c.match(/\(Rating:\s*([\d.]+)\/5\)\s*$/);u&&(a=parseFloat(u[1]),c=c.slice(0,c.lastIndexOf("(")).trim()),console.log("[Parser] Extracted - seller:",c,"rating:",a,"source:",n);let h=0,m="ILS";for(let t=e+1;t<Math.min(e+7,r.length);t++){let e=r[t].trim();if(/^\d+\.\s/.test(e))break;let s=e.match(/Price:\s*([\d,]+(?:\.\d+)?)\s*(\w+)?/i);s&&console.log("[Parser] Found price:",h=parseFloat(s[1].replace(/,/g,"")),m=s[2]||"ILS");let a=e.match(/URL:\s*(https?:\/\/[^\s]+)/i);a&&(o=a[1]);let n=e.match(/Contact:\s*(\+?[\d\s-]+)/i);n&&(l=n[1].replace(/[\s-]/g,""))}h>0?(t.push({seller:c,price:h,currency:m,rating:a,url:o,phone:l,source:n}),console.log("[Parser] Added result:",c,h)):console.log("[Parser] Skipped (no price):",c)}}return console.log("[Parser] Section results:",t.length),t}function et(e){let t;let r=[],s=/(?:^|\n)(\d+)\.\s+([^\n]+)/g;for(;null!==(t=s.exec(e));){let s,a;let n=t[2],o=n.match(/(.+?)\s*\(Rating:\s*([\d.]+)\/5\)/);o?(s=o[1].trim(),a=parseFloat(o[2])):s=n.trim();let l=t.index+t[0].length,i=e.slice(l).match(/\n\d+\./),c=i&&void 0!==i.index?l+i.index:e.length,d=e.slice(l,c),u=d.match(/Price:\s*([\d,]+)/i),h=u?parseInt(u[1].replace(/,/g,""),10):0,m=d.match(/Price:\s*[\d,]+\s*(\w+)/i),g=m?m[1]:"ILS",x=d.match(/URL:\s*(https?:\/\/[^\s\n]+)/i),p=x?x[1]:void 0,f=d.match(/(?:Contact|Phone|WhatsApp):\s*(\+?[\d\s-]+)/i),y=f?f[1].replace(/[\s-]/g,""):void 0;h>0&&r.push({seller:s,price:h,currency:g,rating:a,url:p,phone:y})}return r}function er(e){let t;let r=[];if(!e.match(/=== BUNDLE OPPORTUNITIES \((\d+) stores\) ===/))return[];let s=e.indexOf("=== BUNDLE OPPORTUNITIES"),a=e.slice(s+30).match(/\n===\s+[^B]/),n=a?s+30+a.index:e.length,o=e.slice(s,n),l=/(\d+)\.\s+([^\n]+?)(?:\s+\(Rating:\s*([\d.]+)\/5\))?\n([\s\S]*?)(?=\n\d+\.|$)/g;for(;null!==(t=l.exec(o));){let e;let s=t[2].trim(),a=t[3]?parseFloat(t[3]):void 0,n=t[4],o=n.match(/Offers\s+(\d+)\/(\d+)\s+products/),l=o?parseInt(o[1]):0,i=o?parseInt(o[2]):0,c=[],d=/^\s+-\s+([^:]+):\s+([\d,]+)\s+(\w+)(?:\s*\|\s*(https?:\/\/[^\s]+))?/gm;for(;null!==(e=d.exec(n));)c.push({name:e[1].trim(),price:parseInt(e[2].replace(/,/g,""),10),currency:e[3],url:e[4]||void 0});let u=n.match(/Total:\s+([\d,]+)/),h=u?parseInt(u[1].replace(/,/g,""),10):0,m=n.match(/Contact:\s*(\+?[\d\s-]+)/),g=m?m[1].replace(/[\s-]/g,""):void 0;h>0&&r.push({storeName:s,rating:a,productCount:l,totalProducts:i,products:c,totalPrice:h,contact:g})}return r}},3425:function(e,t,r){"use strict";r.d(t,{T:function(){return c}});var s=r(7437),a=r(7850),n=r(2265),o=r(3448);function l(e){let{isOpen:t,onClose:r,title:a,children:l,footer:i,className:c}=e;return((0,n.useEffect)(()=>{let e=e=>{"Escape"===e.key&&r()};return t&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[t,r]),t)?(0,s.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",onClick:r,children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-black/70"}),(0,s.jsxs)("div",{className:(0,o.cn)("relative bg-surface rounded-xl max-w-2xl w-[90%] max-h-[80vh] overflow-hidden","shadow-2xl",c),onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between px-5 py-4 border-b border-surface-hover",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold",children:a}),(0,s.jsx)("button",{onClick:r,className:"text-secondary hover:text-gray-800 text-2xl leading-none",children:"\xd7"})]}),(0,s.jsx)("div",{className:"p-4 overflow-y-auto max-h-[60vh]",children:l}),i&&(0,s.jsx)("div",{className:"flex justify-end gap-3 px-5 py-4 border-t border-surface-hover",children:i})]})]}):null}var i=r(6334);function c(){let{isModalOpen:e,closeModal:t,drafts:r,sentIndices:n,updateDraftMessage:c,updateDraftPhone:d,markAsSent:u,isGenerating:h,error:m}=(0,a.z)(),g=e=>{let t=r[e];window.open(t.wa_link,"_blank"),u(e)},x=async e=>{let t=r[e];await navigator.clipboard.writeText(t.wa_link)};return(0,s.jsx)(l,{isOpen:e,onClose:t,title:"Review Negotiation Messages",footer:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.z,{variant:"success",onClick:()=>{r.forEach((e,t)=>{n.has(t)||setTimeout(()=>g(t),500*t)})},children:"Send All via WhatsApp"}),(0,s.jsx)(i.z,{variant:"secondary",onClick:t,children:"Cancel"})]}),children:h?(0,s.jsx)("p",{className:"text-secondary text-center py-8",children:"Generating drafts..."}):m?(0,s.jsx)("p",{className:"text-error text-center py-8",children:m}):(0,s.jsx)("div",{className:"space-y-4",children:r.map((e,t)=>(0,s.jsxs)("div",{className:(0,o.cn)("bg-background rounded-lg p-4",n.has(t)&&"opacity-60 border-2 border-success"),children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)("input",{type:"checkbox",checked:!0,readOnly:!0,className:"w-4 h-4"}),(0,s.jsx)("strong",{className:"text-primary",children:e.seller_name})]}),(0,s.jsxs)("p",{className:"text-sm text-secondary mb-3",children:["Product: ",e.product_name]}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsx)("label",{className:"block text-xs text-secondary mb-1",children:"Phone Number:"}),(0,s.jsx)("input",{type:"text",value:e.phone_number,onChange:e=>d(t,e.target.value),className:"w-48 px-3 py-1.5 bg-surface border border-surface-hover rounded text-gray-800 text-sm focus:outline-none focus:border-primary"})]}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsx)("label",{className:"block text-xs text-secondary mb-1",children:"Message:"}),(0,s.jsx)("textarea",{value:e.message,onChange:e=>c(t,e.target.value),className:"w-full min-h-[80px] px-3 py-2 bg-surface border border-surface-hover rounded text-gray-800 text-sm resize-y focus:outline-none focus:border-primary"})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.z,{variant:"success",size:"sm",onClick:()=>g(t),disabled:n.has(t),children:n.has(t)?"✓ Opened":"\uD83D\uDCF1 Send via WhatsApp"}),(0,s.jsx)(i.z,{variant:"secondary",size:"sm",onClick:()=>x(t),children:"\uD83D\uDD17 Copy Link"})]})]},t))})})}},6334:function(e,t,r){"use strict";r.d(t,{z:function(){return i}});var s=r(7437),a=r(3448),n=r(2265);let o={primary:"bg-cyan-600 text-white hover:bg-cyan-500",secondary:"bg-slate-700 text-slate-300 hover:bg-slate-600",success:"bg-emerald-600 text-white hover:bg-emerald-500",danger:"bg-red-600 text-white hover:bg-red-500",ghost:"bg-transparent text-slate-300 hover:bg-slate-700"},l={sm:"px-2 py-1 text-xs",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"},i=(0,n.forwardRef)((e,t)=>{let{variant:r="primary",size:n="md",className:i,disabled:c,...d}=e;return(0,s.jsx)("button",{ref:t,className:(0,a.cn)("inline-flex items-center justify-center rounded font-medium transition-colors","focus:outline-none focus:ring-2 focus:ring-cyan-500/50","disabled:opacity-50 disabled:cursor-not-allowed",o[r],l[n],i),disabled:c,...d})});i.displayName="Button"},1837:function(e,t,r){"use strict";r.d(t,{h:function(){return a}});class s{async fetch(e,t){let r=await fetch("".concat(this.baseUrl).concat(e),{...t,headers:{"Content-Type":"application/json",...null==t?void 0:t.headers}});if(!r.ok)throw Error("API error: ".concat(r.status," ").concat(r.statusText));return r.json()}async getTraces(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return(await this.fetch("/traces/?limit=".concat(e))).traces}async getTrace(e){return this.fetch("/traces/".concat(e))}async deleteTrace(e){await this.fetch("/traces/".concat(e),{method:"DELETE"})}async runQuery(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"research";return this.fetch("/agent/run",{method:"POST",body:JSON.stringify({query:e,agent:t})})}async generateDrafts(e){return this.fetch("/agent/generate-drafts",{method:"POST",body:JSON.stringify(e)})}async lookupContacts(e){return(await this.fetch("/api/sellers/contacts",{method:"POST",body:JSON.stringify({domains:e})})).contacts}async getSellers(){return(await this.fetch("/api/sellers/")).sellers}async runDiscovery(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"IL";return this.fetch("/agent/run",{method:"POST",body:JSON.stringify({query:e,agent:"discovery",country:t})})}async runDiscoveryRefinement(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"IL",r=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;return this.fetch("/agent/run",{method:"POST",body:JSON.stringify({query:e,agent:"discovery",country:t,conversation_history:r,session_id:s,parent_trace_id:a})})}async getCountry(){return this.fetch("/api/geo/country")}async startPriceSearch(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"IL";return this.fetch("/api/shopping-list/search-prices",{method:"POST",body:JSON.stringify({items:e,country:t})})}async getSearchStatus(e){return this.fetch("/api/shopping-list/search-status/".concat(e))}constructor(e="http://localhost:8000"){this.baseUrl=e}}let a=new s},3448:function(e,t,r){"use strict";r.d(t,{$G:function(){return c},LU:function(){return l},T4:function(){return i},cn:function(){return n},kU:function(){return d},p6:function(){return o}});var s=r(1994),a=r(3335);function n(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,a.m6)((0,s.W)(t))}function o(e){return e?new Date(e).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):""}function l(e){return e<1e3?"".concat(e,"ms"):"".concat((e/1e3).toFixed(1),"s")}function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ILS";return"".concat(e.toLocaleString()," ").concat(t)}function c(e,t){return e?e.length<=t?e:e.slice(0,t-3)+"...":""}function d(e,t){let r=e.replace(/[^0-9]/g,""),s="https://wa.me/".concat(r);return t&&(s+="?text=".concat(encodeURIComponent(t))),s}},7850:function(e,t,r){"use strict";r.d(t,{z:function(){return o}});var s=r(9625),a=r(1837),n=r(3448);let o=(0,s.Ue)((e,t)=>({isModalOpen:!1,isGenerating:!1,drafts:[],sentIndices:new Set,error:null,openModal:()=>e({isModalOpen:!0}),closeModal:()=>e({isModalOpen:!1,drafts:[],sentIndices:new Set,error:null}),updateDraftMessage:(t,r)=>e(e=>{let s=[...e.drafts];return s[t]&&(s[t]={...s[t],message:r,wa_link:(0,n.kU)(s[t].phone_number,r)}),{drafts:s}}),updateDraftPhone:(t,r)=>e(e=>{let s=[...e.drafts];return s[t]&&(s[t]={...s[t],phone_number:r,wa_link:(0,n.kU)(r,s[t].message)}),{drafts:s}}),markAsSent:t=>e(e=>({sentIndices:new Set([...e.sentIndices,t])})),clearDrafts:()=>e({drafts:[],sentIndices:new Set,error:null}),generateDrafts:async function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"he";e({isGenerating:!0,error:null});try{let s=await a.h.generateDrafts({sellers:t,language:r});e({drafts:s.drafts,isGenerating:!1,isModalOpen:!0})}catch(t){e({error:t instanceof Error?t.message:"Failed to generate drafts",isGenerating:!1})}}}))}},function(e){e.O(0,[929,971,117,744],function(){return e(e.s=2177)}),_N_E=e.O()}]);