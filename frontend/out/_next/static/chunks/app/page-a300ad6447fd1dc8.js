(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{2177:function(e,t,r){Promise.resolve().then(r.bind(r,9928))},9928:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return $}});var s,a,o=r(7437),n=r(2265),l=r(9376);let i=null;function c(){return i||(i=localStorage.getItem("analytics_session_id"))||(i="sess_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),localStorage.setItem("analytics_session_id",i)),i}let d=[],u=null;function h(e,t,r){let s={category:e,action:t,label:null==r?void 0:r.label,value:null==r?void 0:r.value,data:null==r?void 0:r.data,timestamp:Date.now()};d.push(s),u||(u=setTimeout(()=>{m(),u=null},1e3))}async function m(){if(0===d.length)return;let e=[...d];d.length=0;try{await fetch("".concat("","/api/analytics/events"),{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":c()},body:JSON.stringify({events:e})})}catch(t){d.push(...e),console.error("[Analytics] Failed to send events:",t)}}function g(e,t){h("page_view","view",{label:e,data:{referrer:t,url:window.location.href}})}function x(e,t,r){h("search","submit",{label:e,value:t,data:{durationMs:r}})}function p(e,t,r){h("error",e,{label:t,data:{stack:null==r?void 0:r.slice(0,500)}})}{g(window.location.pathname,document.referrer);let e=history.pushState;history.pushState=function(){for(var t=arguments.length,r=Array(t),s=0;s<t;s++)r[s]=arguments[s];e.apply(history,r),g(window.location.pathname)},window.addEventListener("popstate",()=>{g(window.location.pathname)}),window.addEventListener("error",e=>{var t;p("uncaught_error",e.message,null===(t=e.error)||void 0===t?void 0:t.stack)}),window.addEventListener("unhandledrejection",e=>{p("unhandled_rejection",String(e.reason))}),window.addEventListener("beforeunload",()=>{d.length>0&&navigator.sendBeacon("".concat("","/api/analytics/events"),JSON.stringify({events:d,session_id:c()}))})}let f="shoppingagent_search_history",y="priceagent_search_history";function v(){try{let e=localStorage.getItem(f);if(!e)return[];return JSON.parse(e).map(e=>({...e,status:e.status||"completed"})).sort((e,t)=>t.timestamp-e.timestamp)}catch(e){return console.error("[SearchHistory] Failed to load:",e),[]}}function b(e){let t=v(),r={...e,id:"search_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9))};t.unshift(r);let s=t.slice(0,50);try{localStorage.setItem(f,JSON.stringify(s))}catch(e){console.error("[SearchHistory] Failed to save:",e)}return r}function j(e,t){let r=v(),s=r.findIndex(t=>t.traceId===e);if(-1===s)return console.warn("[SearchHistory] Item not found for traceId:",e),null;let a=r[s];void 0!==t.resultCount&&(a.resultCount=t.resultCount),void 0!==t.status&&(a.status=t.status),void 0!==t.error&&(a.error=t.error),void 0!==t.topResults&&(a.topResults=t.topResults),void 0!==t.searchTimeMs&&(a.searchTimeMs=t.searchTimeMs);try{localStorage.setItem(f,JSON.stringify(r))}catch(e){console.error("[SearchHistory] Failed to update:",e)}return a}function N(e){let t=v().filter(t=>t.id!==e);try{localStorage.setItem(f,JSON.stringify(t))}catch(e){console.error("[SearchHistory] Failed to delete:",e)}}function w(e){let t=Date.now()-e,r=Math.floor(t/6e4),s=Math.floor(t/36e5),a=Math.floor(t/864e5);return r<1?"Just now":r<60?"".concat(r,"m ago"):s<24?"".concat(s,"h ago"):a<7?"".concat(a,"d ago"):new Date(e).toLocaleDateString()}!function(){try{let e=localStorage.getItem(y),t=localStorage.getItem(f);e&&!t&&(console.log("[SearchHistory] Migrating from old storage key"),localStorage.setItem(f,e),localStorage.removeItem(y))}catch(e){console.error("[SearchHistory] Migration failed:",e)}}();var k=r(1837),S=r(7850),_=r(3425),C=r(9625);let L="shoppingagent_discovery_history";function D(){try{let e=localStorage.getItem(L);if(!e)return[];return JSON.parse(e).map(e=>({...e,status:e.status||"completed"})).sort((e,t)=>t.timestamp-e.timestamp)}catch(e){return console.error("[DiscoveryHistory] Failed to load:",e),[]}}let I=(0,C.Ue)((e,t)=>({query:"",country:"IL",isSearching:!1,isLoadingFromHistory:!1,currentTraceId:null,originalTraceId:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],error:null,statusMessage:null,history:[],messages:[],sessionId:null,setQuery:t=>e({query:t}),setCountry:t=>e({country:t}),setProducts:t=>e({products:t}),setError:t=>e({error:t}),setStatusMessage:t=>e({statusMessage:t}),clearResults:()=>e({products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],error:null,statusMessage:null,currentTraceId:null,originalTraceId:null,messages:[],sessionId:null}),clearConversation:()=>e({messages:[],sessionId:null}),loadHistory:()=>{e({history:D()})},runDiscovery:async(r,s)=>{let a=s||t().country,o="session_".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,9)),n={id:"msg_".concat(Date.now()),role:"user",content:r,timestamp:Date.now()};e({isSearching:!0,error:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],query:r,country:a,statusMessage:"Starting product discovery...",messages:[n],sessionId:o,currentTraceId:null,originalTraceId:null});try{let t=await k.h.runDiscovery(r,a),s=function(e){let t=D();if(e.traceId){let r=t.findIndex(t=>t.traceId===e.traceId);if(-1!==r){let s=t[r];s.productCount=e.productCount,s.timestamp=e.timestamp,s.status=e.status,e.error&&(s.error=e.error),t.splice(r,1),t.unshift(s);try{localStorage.setItem(L,JSON.stringify(t))}catch(e){console.error("[DiscoveryHistory] Failed to save:",e)}return s}}let r={...e,id:"discovery_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9))};t.unshift(r);let s=t.slice(0,50);try{localStorage.setItem(L,JSON.stringify(s))}catch(e){console.error("[DiscoveryHistory] Failed to save:",e)}return r}({query:r,timestamp:Date.now(),productCount:0,traceId:t.trace_id,status:"searching"});return e(e=>({currentTraceId:t.trace_id,originalTraceId:t.trace_id,statusMessage:"Researching products...",history:[s,...e.history.filter(e=>e.traceId!==t.trace_id).slice(0,49)]})),t.trace_id}catch(t){throw e({error:t instanceof Error?t.message:"Discovery failed",isSearching:!1,statusMessage:null}),t}},sendRefinement:async r=>{let{products:s,country:a,messages:o,sessionId:n,originalTraceId:l}=t();if(!n)throw Error("No active session");let i={id:"msg_".concat(Date.now()),role:"user",content:r,timestamp:Date.now(),productsSnapshot:s};e(e=>({isSearching:!0,error:null,statusMessage:"Refining search...",messages:[...e.messages,i]}));try{let t=o.map(e=>({role:e.role,content:e.content}));t.push({role:"user",content:r});let s=await k.h.runDiscoveryRefinement(r,a,t,n,l||void 0);return e({currentTraceId:s.trace_id,statusMessage:"Updating recommendations..."}),s.trace_id}catch(t){throw e({error:t instanceof Error?t.message:"Refinement failed",isSearching:!1,statusMessage:null}),t}},setSearchComplete:r=>{let{query:s,currentTraceId:a,originalTraceId:o}=t(),n=r.products||[],l=o&&a!==o;console.log("[Discovery] setSearchComplete:",{query:s,currentTraceId:a,originalTraceId:o,isRefinement:l,productCount:n.length});let i=n.length>0?"Found ".concat(n.length," product").concat(1===n.length?"":"s"," matching your criteria."):r.no_results_message||"No products found matching your criteria.",c={id:"msg_".concat(Date.now()),role:"assistant",content:i,timestamp:Date.now(),traceId:a||void 0,productsSnapshot:n};if(a&&!l){console.log("[Discovery] Updating history status to completed:",a),function(e,t){let r=D(),s=r.findIndex(t=>t.traceId===e);if(-1===s)return console.warn("[DiscoveryHistory] Item not found for traceId:",e);let a=r[s];void 0!==t.productCount&&(a.productCount=t.productCount),void 0!==t.status&&(a.status=t.status),void 0!==t.error&&(a.error=t.error);try{localStorage.setItem(L,JSON.stringify(r))}catch(e){console.error("[DiscoveryHistory] Failed to update:",e)}}(a,{status:"completed",productCount:n.length});let t=Array.isArray(r.criteria_feedback)?r.criteria_feedback:r.criteria_feedback?[r.criteria_feedback]:[];e(e=>({products:n,searchSummary:r.search_summary||null,noResultsMessage:r.no_results_message||null,suggestions:r.suggestions||[],criteriaFeedback:t,isSearching:!1,statusMessage:null,history:e.history.map(e=>e.traceId===a?{...e,status:"completed",productCount:n.length}:e),messages:[...e.messages,c]}))}else{let t=Array.isArray(r.criteria_feedback)?r.criteria_feedback:r.criteria_feedback?[r.criteria_feedback]:[];e(e=>({products:n,searchSummary:r.search_summary||null,noResultsMessage:r.no_results_message||null,suggestions:r.suggestions||[],criteriaFeedback:t,isSearching:!1,statusMessage:null,messages:[...e.messages,c]}))}},loadFromTrace:async(t,r)=>{e({isSearching:!0,isLoadingFromHistory:!0,error:null,products:[],searchSummary:null,noResultsMessage:null,suggestions:[],criteriaFeedback:[],query:r,currentTraceId:t,originalTraceId:t,statusMessage:"Loading previous results...",messages:[],sessionId:"session_".concat(Date.now(),"_").concat(Math.random().toString(36).slice(2,9))});try{let s=await fetch("".concat("","/traces/").concat(t));if(!s.ok)throw Error("Failed to load trace");let a=await s.json();console.log("[Discovery] Loaded trace:",t,"status:",a.status,"has final_output:",!!a.final_output);let o=a.final_output||a.output||"",n=(e=>{if(!e)return{products:[]};try{let t="string"==typeof e?JSON.parse(e):e;if(t.products&&Array.isArray(t.products))return t;if(Array.isArray(t))return{products:t}}catch(e){console.log("[Discovery] Could not parse trace output as products")}return{products:[]}})(o);console.log("[Discovery] Parsed",n.products.length,"products from parent trace");let l=[],i=Date.now()-1e4;l.push({id:"msg_".concat(i,"_user"),role:"user",content:r,timestamp:i}),l.push({id:"msg_".concat(i+1e3,"_assistant"),role:"assistant",content:n.products.length>0?"Found ".concat(n.products.length," product").concat(1===n.products.length?"":"s"," matching your criteria."):n.no_results_message||"No products found.",timestamp:i+1e3,traceId:t,productsSnapshot:n.products});let c=n.products,d=Array.isArray(n.criteria_feedback)?n.criteria_feedback:n.criteria_feedback?[n.criteria_feedback]:[];e({products:c,searchSummary:n.search_summary||null,noResultsMessage:n.no_results_message||null,suggestions:n.suggestions||[],criteriaFeedback:d,isSearching:!1,isLoadingFromHistory:!1,statusMessage:null,messages:l,currentTraceId:t})}catch(t){e({error:t instanceof Error?t.message:"Failed to load",isSearching:!1,isLoadingFromHistory:!1,statusMessage:null,sessionId:null})}},deleteFromHistory:t=>{!function(e){let t=D().filter(t=>t.id!==e);try{localStorage.setItem(L,JSON.stringify(t))}catch(e){console.error("[DiscoveryHistory] Failed to delete:",e)}}(t),e(e=>({history:e.history.filter(e=>e.id!==t)}))},loadFromMessage:r=>{let{messages:s}=t(),a=s.find(e=>e.id===r);a&&a.productsSnapshot&&e({products:a.productsSnapshot,currentTraceId:a.traceId||null})}}));function M(e){let t=e.indexOf(":");return -1===t?null:{key:e.substring(0,t).trim(),value:e.substring(t+1).trim()}}function F(e){let{products:t,onAddToList:r,isAddingId:s}=e,a=(0,n.useMemo)(()=>(function(e){let t=new Set,r=[];for(let s of e)for(let e of s.key_specs){let s=M(e);s&&!t.has(s.key)&&(t.add(s.key),r.push(s.key))}return r})(t),[t]),l=(0,n.useMemo)(()=>t.map(e=>(function(e){let t={};for(let r of e.key_specs){let e=M(r);e&&(t[e.key]=e.value)}return t})(e)),[t]);return t&&0!==t.length?(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold text-gray-800",children:["Recommended Products (",t.length,")"]}),(0,o.jsx)("div",{className:"overflow-x-auto",children:(0,o.jsxs)("table",{className:"w-full text-sm border-collapse",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{className:"border-b-2 border-gray-200 text-left text-gray-600 bg-gray-50",children:[(0,o.jsx)("th",{className:"px-3 py-3 font-semibold sticky left-0 bg-gray-50",children:"#"}),(0,o.jsx)("th",{className:"px-3 py-3 font-semibold min-w-[200px]",children:"Product"}),(0,o.jsx)("th",{className:"px-3 py-3 font-semibold",children:"Brand"}),a.map(e=>(0,o.jsx)("th",{className:"px-3 py-3 font-semibold whitespace-nowrap",children:e},e)),(0,o.jsx)("th",{className:"px-3 py-3 font-semibold",children:"Price"}),(0,o.jsx)("th",{className:"px-3 py-3 font-semibold min-w-[150px]",children:"Why Recommended"}),(0,o.jsx)("th",{className:"px-3 py-3 font-semibold text-center",children:"Action"})]})}),(0,o.jsx)("tbody",{children:t.map((e,t)=>(0,o.jsxs)("tr",{className:"border-b border-gray-200/50 hover:bg-indigo-50/30 transition-colors",children:[(0,o.jsx)("td",{className:"px-3 py-3 text-gray-400 sticky left-0 bg-white",children:t+1}),(0,o.jsxs)("td",{className:"px-3 py-3",children:[(0,o.jsx)("div",{className:"font-medium text-gray-800",children:e.name}),e.model_number&&(0,o.jsx)("div",{className:"text-xs font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded inline-block mt-1",children:e.model_number}),(0,o.jsx)("div",{className:"mt-1",children:e.url?(0,o.jsx)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-indigo-600 hover:underline",children:"View product →"}):(0,o.jsx)("a",{href:"https://www.google.com/search?q=".concat(encodeURIComponent((e.brand?e.brand+" ":"")+(e.model_number||e.name))),target:"_blank",rel:"noopener noreferrer",className:"text-xs text-indigo-600 hover:underline",children:"Search →"})})]}),(0,o.jsx)("td",{className:"px-3 py-3 text-gray-600 font-medium",children:e.brand||"-"}),a.map(e=>(0,o.jsx)("td",{className:"px-3 py-3 text-gray-600 whitespace-nowrap",children:l[t][e]||(0,o.jsx)("span",{className:"text-gray-300",children:"-"})},e)),(0,o.jsx)("td",{className:"px-3 py-3 whitespace-nowrap",children:e.price_range?(0,o.jsx)("span",{className:"text-emerald-600 font-semibold",children:e.price_range}):e.price?(0,o.jsxs)("span",{className:"text-emerald-600 font-semibold",children:["ILS"===e.currency?"₪":e.currency,e.price.toLocaleString()]}):(0,o.jsx)("span",{className:"text-gray-300",children:"-"})}),(0,o.jsx)("td",{className:"px-3 py-3 max-w-[200px]",children:(0,o.jsx)("p",{className:"text-xs text-gray-500 line-clamp-3 cursor-help",title:e.why_recommended||void 0,children:e.why_recommended||"-"})}),(0,o.jsx)("td",{className:"px-3 py-3 text-center",children:(0,o.jsx)("button",{onClick:()=>r(e),disabled:s===e.id,className:"px-3 py-1.5 text-xs font-medium bg-indigo-100 text-indigo-700 hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:cursor-wait rounded-lg transition-colors",children:s===e.id?"Adding...":"Add to List"})})]},e.id))})]})})]}):null}let E=[{code:"IL",name:"Israel",flag:"\uD83C\uDDEE\uD83C\uDDF1"},{code:"US",name:"United States",flag:"\uD83C\uDDFA\uD83C\uDDF8"},{code:"UK",name:"United Kingdom",flag:"\uD83C\uDDEC\uD83C\uDDE7"},{code:"DE",name:"Germany",flag:"\uD83C\uDDE9\uD83C\uDDEA"},{code:"FR",name:"France",flag:"\uD83C\uDDEB\uD83C\uDDF7"}];function P(e){let{value:t,onChange:r,compact:s=!1}=e;return(E.find(e=>e.code===t)||E[0],s)?(0,o.jsx)("select",{value:t,onChange:e=>r(e.target.value),className:"bg-white border border-gray-200 text-gray-600 text-sm rounded-lg px-2 py-1 outline-none focus:border-indigo-500 cursor-pointer",children:E.map(e=>(0,o.jsxs)("option",{value:e.code,children:[e.flag," ",e.code]},e.code))}):(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("span",{className:"text-sm text-gray-500",children:"Region:"}),(0,o.jsx)("select",{value:t,onChange:e=>r(e.target.value),className:"bg-white border border-gray-200 text-gray-600 text-sm rounded-lg px-3 py-1.5 outline-none focus:border-indigo-500 cursor-pointer",children:E.map(e=>(0,o.jsxs)("option",{value:e.code,children:[e.flag," ",e.name]},e.code))})]})}function W(e){try{let t=JSON.parse(e),r=e=>e.map((e,t)=>({id:String(e.id||"prod_".concat(Date.now(),"_").concat(t)),name:String(e.name||"Unknown Product"),brand:e.brand?String(e.brand):void 0,model_number:e.model_number?String(e.model_number):void 0,category:String(e.category||"product"),key_specs:Array.isArray(e.key_specs)?e.key_specs.map(String):[],price_range:e.price_range?String(e.price_range):void 0,why_recommended:String(e.why_recommended||""),price:"number"==typeof e.price?e.price:void 0,currency:e.currency?String(e.currency):void 0,url:e.url?String(e.url):void 0,rating:"number"==typeof e.rating?e.rating:void 0}));if(t.products&&Array.isArray(t.products))return{products:r(t.products),search_summary:t.search_summary,no_results_message:t.no_results_message,suggestions:t.suggestions,criteria_feedback:t.criteria_feedback};if(Array.isArray(t))return{products:r(t)};return console.log("[Discovery] Output is not a products array:",t),{products:[]}}catch(r){let t=e.match(/\{[\s\S]*"products"[\s\S]*\}/);if(t)try{let e=JSON.parse(t[0]);if(e.products&&Array.isArray(e.products))return W(JSON.stringify(e))}catch(e){console.log("[Discovery] Failed to extract JSON from output")}return console.log("[Discovery] Failed to parse output as JSON:",r),{products:[]}}}function B(e){let{onAddToShoppingList:t,country:r,onCountryChange:s}=e,{query:a,setQuery:l,country:i,setCountry:c,isSearching:d,isLoadingFromHistory:u,currentTraceId:h,products:m,searchSummary:g,noResultsMessage:x,suggestions:p,criteriaFeedback:f,error:y,statusMessage:v,messages:b,sessionId:j,setStatusMessage:N,setError:w,runDiscovery:k,sendRefinement:S,setSearchComplete:_,clearResults:C,loadFromMessage:L}=I();(0,n.useEffect)(()=>{r!==i&&c(r)},[r,i,c]);let[D,M]=(0,n.useState)(),[E,B]=(0,n.useState)(a),[R,T]=(0,n.useState)(""),A=(0,n.useRef)(null),O=(0,n.useRef)(null),z=(0,n.useRef)(null);(0,n.useEffect)(()=>{z.current=h},[h]),(0,n.useEffect)(()=>{a!==E&&B(a)},[a]),(0,n.useEffect)(()=>{if(!h||!d||u)return;A.current&&(A.current.close(),A.current=null);let e="".concat("https:"===window.location.protocol?"wss:":"ws:","//").concat(window.location.host);console.log("[Discovery] Connecting WebSocket for trace:",h);let t=new WebSocket("".concat(e,"/traces/ws"));return A.current=t,t.onopen=()=>{console.log("[Discovery] WebSocket connected for trace:",h)},t.onmessage=e=>{try{var r,s,a;let o=JSON.parse(e.data);if(o.trace_id!==h)return;if(z.current!==h){console.log("[Discovery] Ignoring message for old trace:",h),t.close();return}if("span_started"===o.event_type&&(null===(r=o.data)||void 0===r?void 0:r.name)&&N(o.data.name),"trace_ended"===o.event_type){if(console.log("[Discovery] Trace completed:",h),null===(s=o.data)||void 0===s?void 0:s.error)console.error("[Discovery] Trace error:",o.data.error),w(o.data.error),_({products:[]});else{let e=(null===(a=o.data)||void 0===a?void 0:a.final_output)||"";console.log("[Discovery] Final output length:",e.length),console.log("[Discovery] Final output preview:",e.substring(0,500));let t=W(e);console.log("[Discovery] Parsed products:",t.products.length),0===t.products.length&&e.length>0&&console.log("[Discovery] No products parsed, full output:",e),_(t)}t.close()}}catch(e){console.error("[Discovery] WebSocket message parse error:",e)}},t.onerror=e=>{console.error("[Discovery] WebSocket error:",e)},t.onclose=()=>{console.log("[Discovery] WebSocket closed for trace:",h),z.current===h&&setTimeout(()=>{let e=I.getState();e.isSearching&&e.currentTraceId===h&&(console.log("[Discovery] Fetching trace directly as fallback"),fetch("".concat("","/traces/").concat(h)).then(e=>e.json()).then(e=>{"completed"===e.status&&e.final_output?_(W(e.final_output)):"error"===e.status&&(w(e.error||"Discovery failed"),_({products:[]}))}).catch(e=>{console.error("[Discovery] Fallback fetch failed:",e)}))},100)},()=>{A.current&&(A.current.close(),A.current=null)}},[h,d,u,N,w,_]);let H=(0,n.useCallback)(async e=>{if(e.preventDefault(),E.trim()&&!d)try{await k(E,r)}catch(e){console.error("[Discovery] Search failed:",e)}},[E,d,k,r]),J=(0,n.useCallback)(e=>{M(e.id),t({product_name:e.name,model_number:e.model_number,specs_summary:e.key_specs.slice(0,3).join(", "),source:"discovery"}),setTimeout(()=>M(void 0),500)},[t]),U=e=>{B(e),l(e)},V=(0,n.useCallback)(async e=>{if(e.preventDefault(),R.trim()&&!d&&j)try{await S(R),T("")}catch(e){console.error("[Discovery] Refinement failed:",e)}},[R,d,j,S]);return(0,n.useEffect)(()=>{O.current&&b.length>0&&O.current.scrollIntoView({behavior:"smooth"})},[b.length]),(0,o.jsxs)("div",{className:"space-y-6",children:[(0,o.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"What are you looking for?"}),(0,o.jsx)("p",{className:"text-gray-500 text-sm mb-4",children:"Describe your needs in natural language - our AI will find the best products for you."}),(0,o.jsxs)("form",{onSubmit:H,className:"space-y-4",children:[(0,o.jsx)("textarea",{value:E,onChange:e=>B(e.target.value),placeholder:"Example: I need a silent refrigerator for a family of 4 with an open kitchen layout",dir:"auto",className:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 outline-none resize-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-300",rows:3,disabled:d}),(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[s?(0,o.jsx)(P,{value:r,onChange:s,compact:!0}):(0,o.jsxs)("div",{className:"text-xs text-gray-400",children:["Country: ",r]}),(0,o.jsx)("button",{type:"submit",disabled:d||!E.trim(),className:"px-6 py-2.5 bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-400 hover:to-blue-400 disabled:from-gray-200 disabled:to-gray-200 text-white font-medium rounded-xl transition-all duration-300 flex items-center gap-2",children:d?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Discovering..."]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})}),"Discover Products"]})})]})]}),d&&v&&(0,o.jsx)("div",{className:"mt-4 text-center text-gray-500 text-sm animate-pulse",children:v}),y&&(0,o.jsx)("div",{className:"mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:y})]}),!d&&0===m.length&&!y&&(x||f.length>0||g)&&(0,o.jsxs)("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 space-y-4",children:[x&&(0,o.jsx)("div",{className:"text-amber-400 font-medium",children:x}),g&&(0,o.jsxs)("div",{className:"space-y-2",children:[(0,o.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"What we searched for:"}),(0,o.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,o.jsxs)("span",{className:"text-indigo-600",children:["“",g.original_requirement,"”"]}),g.category&&(0,o.jsxs)("span",{className:"ml-2 text-gray-400",children:["(",g.category,")"]})]}),g.search_attempts&&g.search_attempts.length>0&&(0,o.jsx)("div",{className:"mt-2",children:(0,o.jsxs)("span",{className:"text-gray-400 text-xs",children:["Searched ",g.search_attempts.length," queries across"," ",g.search_attempts.reduce((e,t)=>{var r;return e+((null===(r=t.scrapers)||void 0===r?void 0:r.length)||0)},0)," sources"]})})]}),f.length>0&&(0,o.jsxs)("div",{className:"space-y-2",children:[(0,o.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"Search criteria used:"}),(0,o.jsx)("ul",{className:"text-gray-500 text-sm space-y-1",children:f.map((e,t)=>(0,o.jsx)("li",{className:"flex items-start",children:(0,o.jsx)("span",{className:"text-indigo-600 mr-2",children:e})},t))})]}),p.length>0&&(0,o.jsxs)("div",{className:"space-y-2",children:[(0,o.jsx)("h3",{className:"text-gray-600 text-sm font-medium",children:"Suggestions:"}),(0,o.jsx)("ul",{className:"text-gray-500 text-sm space-y-1",children:p.map((e,t)=>(0,o.jsxs)("li",{className:"flex items-start",children:[(0,o.jsx)("span",{className:"text-amber-400 mr-2",children:"•"}),(0,o.jsx)("span",{children:e})]},t))})]}),(0,o.jsx)("button",{onClick:C,className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Clear and try again"})]}),!d&&0===m.length&&!y&&!x&&!g&&0===f.length&&(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("p",{className:"text-gray-400 text-sm mb-3",children:"Or try one of these examples:"}),(0,o.jsx)("div",{className:"flex flex-wrap justify-center gap-2",children:["Silent refrigerator for family of 4","Energy efficient washing machine for small apartment","Quiet dishwasher with good drying","Large capacity oven for baking"].map(e=>(0,o.jsx)("button",{onClick:()=>U(e),className:"px-3 py-1.5 text-sm text-gray-500 bg-white shadow-soft rounded-lg hover:bg-gray-100 hover:text-gray-800 transition-colors",children:e},e))})]}),m.length>0&&(0,o.jsxs)("div",{className:"bg-white/30 border border-gray-200 rounded-xl p-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,o.jsxs)("span",{className:"text-gray-500 text-sm",children:["Found ",m.length," recommended products"]}),(0,o.jsx)("button",{onClick:C,className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Clear results"})]}),(null==g?void 0:g.criteria_used)&&g.criteria_used.length>0&&(0,o.jsxs)("div",{className:"mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,o.jsxs)("span",{className:"text-indigo-700 text-sm font-medium",children:["Search criteria (",g.criteria_used.length,"):"]}),(0,o.jsx)("span",{className:"text-gray-500 text-xs",children:g.category&&"Category: ".concat(g.category)})]}),(0,o.jsxs)("div",{className:"flex flex-wrap gap-2",children:[g.criteria_used.slice(0,8).map((e,t)=>(0,o.jsxs)("span",{className:"inline-flex items-center px-2 py-1 text-xs rounded-full bg-white border border-indigo-200 text-gray-700",title:e.explanation||e.market_context||void 0,children:[(0,o.jsxs)("span",{className:"font-medium text-indigo-600 mr-1",children:[e.attribute,":"]}),(0,o.jsx)("span",{children:e.market_value||e.value||e.ideal_value||"any"}),"user"===e.source&&(0,o.jsx)("span",{className:"ml-1 text-indigo-400 text-[10px]",children:"(you)"})]},t)),g.criteria_used.length>8&&(0,o.jsxs)("span",{className:"text-xs text-gray-400 self-center",children:["+",g.criteria_used.length-8," more"]})]})]}),(null==g?void 0:g.filtering_notes)&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:(0,o.jsxs)("div",{className:"text-blue-400 text-sm",children:[(0,o.jsx)("span",{className:"font-medium",children:"Note:"})," ",g.filtering_notes]})}),(null==g?void 0:g.market_notes)&&!(null==g?void 0:g.filtering_notes)&&(0,o.jsx)("div",{className:"mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg",children:(0,o.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,o.jsx)("span",{className:"font-medium",children:"Market info:"})," ",g.market_notes]})}),(0,o.jsx)(F,{products:m,onAddToList:J,isAddingId:D}),j&&(0,o.jsxs)("div",{className:"mt-6 border-t border-gray-200 pt-6",children:[(0,o.jsx)("h3",{className:"text-sm font-medium text-gray-600 mb-3",children:"Refine your search"}),b.length>1&&(0,o.jsxs)("div",{className:"mb-4 max-h-40 overflow-y-auto space-y-2 pr-2",children:[b.slice(1).map(e=>{let t="assistant"===e.role,r=t&&e.traceId===h,s=t&&e.productsSnapshot&&e.productsSnapshot.length>0;return(0,o.jsxs)("div",{onClick:()=>{s&&L(e.id)},className:"text-sm rounded-lg px-3 py-2 ".concat("user"===e.role?"bg-indigo-50 text-indigo-700 ml-8":"mr-8 ".concat(r?"bg-indigo-100 text-indigo-700 border border-indigo-300":"bg-gray-50 text-gray-600"," ").concat(s?"cursor-pointer hover:bg-gray-100":"")),title:s?"Click to view these results":void 0,children:[(0,o.jsxs)("span",{className:"font-medium",children:["user"===e.role?"You":"AI",":"]})," ",e.content,s&&(0,o.jsx)("span",{className:"ml-1 text-xs text-gray-400",children:"(click to view)"})]},e.id)}),(0,o.jsx)("div",{ref:O})]}),(0,o.jsxs)("form",{onSubmit:V,className:"flex gap-2",children:[(0,o.jsx)("input",{type:"text",value:R,onChange:e=>T(e.target.value),placeholder:"e.g., 'show cheaper options' or 'prefer Samsung'",dir:"auto",className:"flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition-all duration-300",disabled:d}),(0,o.jsxs)("button",{type:"submit",disabled:d||!R.trim(),className:"px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 hover:from-indigo-400 hover:to-blue-400 disabled:from-gray-200 disabled:to-gray-200 text-white text-sm font-medium rounded-lg transition-all duration-300 flex items-center gap-1",children:[d?(0,o.jsxs)("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})}),"Refine"]})]}),(0,o.jsx)("div",{className:"mt-2 flex flex-wrap gap-2",children:["cheaper options","quieter models","larger capacity","different brands"].map(e=>(0,o.jsx)("button",{onClick:()=>T(e),disabled:d,className:"text-xs text-gray-500 bg-white hover:bg-gray-100 px-2 py-1 rounded transition-colors disabled:opacity-50",children:e},e))})]})]})]})}function R(e,t){let r;try{r=e()}catch(e){return}return{getItem:e=>{var s;let a=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),o=null!=(s=r.getItem(e))?s:null;return o instanceof Promise?o.then(a):a(o)},setItem:(e,s)=>r.setItem(e,JSON.stringify(s,null==t?void 0:t.replacer)),removeItem:e=>r.removeItem(e)}}let T=e=>t=>{try{let r=e(t);if(r instanceof Promise)return r;return{then:e=>T(e)(r),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>T(t)(e)}}},A="shoppingagent_shopping_list",O="priceagent_shopping_list";!function(){try{let e=localStorage.getItem(O),t=localStorage.getItem(A);e&&!t&&(console.log("[ShoppingList] Migrating from old storage key"),localStorage.setItem(A,e),localStorage.removeItem(O))}catch(e){console.error("[ShoppingList] Migration failed:",e)}}();let z=(0,C.Ue)()((s=(e,t)=>({items:[],isLoading:!1,isSearching:!1,activeSearchSession:null,addItem:t=>{let r={...t,id:"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)),added_at:new Date().toISOString()};return e(e=>({items:[r,...e.items]})),r},removeItem:t=>{e(e=>({items:e.items.filter(e=>e.id!==t)}))},updateItem:(t,r)=>{e(e=>({items:e.items.map(e=>e.id===t?{...e,...r}:e)}))},clearList:()=>{e({items:[]})},getItemById:e=>t().items.find(t=>t.id===e),isDuplicate:e=>!!e&&t().items.some(t=>{var r;return(null===(r=t.model_number)||void 0===r?void 0:r.toLowerCase())===e.toLowerCase()}),setActiveSearchSession:t=>{e({activeSearchSession:t})},startPriceSearch:async r=>{let{items:s}=t();if(0===s.length)throw Error("No items to search");e({isSearching:!0});try{let t=s.map(e=>({product_name:e.product_name,model_number:e.model_number})),a=await k.h.startPriceSearch(t,r),o={id:a.session_id,trace_id:a.trace_id,status:"running",country:r,started_at:new Date().toISOString()};return e({activeSearchSession:o}),{sessionId:a.session_id,traceId:a.trace_id}}catch(t){throw e({isSearching:!1}),t}},markSearchComplete:(t,r)=>{e(e=>({isSearching:!1,activeSearchSession:e.activeSearchSession?{...e.activeSearchSession,status:t,completed_at:new Date().toISOString(),error:r}:null}))}}),"getStorage"in(a={name:A,storage:R(()=>localStorage),partialize:e=>({items:e.items})})||"serialize"in a||"deserialize"in a?(console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),(e,t,r)=>{let o,n,l={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...a},i=!1,c=new Set,d=new Set;try{o=l.getStorage()}catch(e){}if(!o)return s((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${l.name}', the given storage is currently unavailable.`),e(...t)},t,r);let u=T(l.serialize),h=()=>{let e;let r=u({state:l.partialize({...t()}),version:l.version}).then(e=>o.setItem(l.name,e)).catch(t=>{e=t});if(e)throw e;return r},m=r.setState;r.setState=(e,t)=>{m(e,t),h()};let g=s((...t)=>{e(...t),h()},t,r),x=()=>{var r;if(!o)return;i=!1,c.forEach(e=>e(t()));let s=(null==(r=l.onRehydrateStorage)?void 0:r.call(l,t()))||void 0;return T(o.getItem.bind(o))(l.name).then(e=>{if(e)return l.deserialize(e)}).then(e=>{if(e){if("number"!=typeof e.version||e.version===l.version)return e.state;if(l.migrate)return l.migrate(e.state,e.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}}).then(r=>{var s;return e(n=l.merge(r,null!=(s=t())?s:g),!0),h()}).then(()=>{null==s||s(n,void 0),i=!0,d.forEach(e=>e(n))}).catch(e=>{null==s||s(void 0,e)})};return r.persist={setOptions:e=>{l={...l,...e},e.getStorage&&(o=e.getStorage())},clearStorage:()=>{null==o||o.removeItem(l.name)},getOptions:()=>l,rehydrate:()=>x(),hasHydrated:()=>i,onHydrate:e=>(c.add(e),()=>{c.delete(e)}),onFinishHydration:e=>(d.add(e),()=>{d.delete(e)})},x(),n||g}):(e,t,r)=>{let o,n={storage:R(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...a},l=!1,i=new Set,c=new Set,d=n.storage;if(!d)return s((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${n.name}', the given storage is currently unavailable.`),e(...t)},t,r);let u=()=>{let e=n.partialize({...t()});return d.setItem(n.name,{state:e,version:n.version})},h=r.setState;r.setState=(e,t)=>{h(e,t),u()};let m=s((...t)=>{e(...t),u()},t,r);r.getInitialState=()=>m;let g=()=>{var r,s;if(!d)return;l=!1,i.forEach(e=>{var r;return e(null!=(r=t())?r:m)});let a=(null==(s=n.onRehydrateStorage)?void 0:s.call(n,null!=(r=t())?r:m))||void 0;return T(d.getItem.bind(d))(n.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===n.version)return[!1,e.state];if(n.migrate)return[!0,n.migrate(e.state,e.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(r=>{var s;let[a,l]=r;if(e(o=n.merge(l,null!=(s=t())?s:m),!0),a)return u()}).then(()=>{null==a||a(o,void 0),o=t(),l=!0,c.forEach(e=>e(o))}).catch(e=>{null==a||a(void 0,e)})};return r.persist={setOptions:e=>{n={...n,...e},e.storage&&(d=e.storage)},clearStorage:()=>{null==d||d.removeItem(n.name)},getOptions:()=>n,rehydrate:()=>g(),hasHydrated:()=>l,onHydrate:e=>(i.add(e),()=>{i.delete(e)}),onFinishHydration:e=>(c.add(e),()=>{c.delete(e)})},n.skipHydration||g(),o||m}));function H(e){let{item:t,onRemove:r,onEdit:s}=e;return(0,o.jsxs)("div",{className:"flex items-start justify-between p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300 transition-colors group shadow-soft",children:[(0,o.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)("h3",{className:"text-gray-800 font-medium truncate",children:t.product_name}),"discovery"===t.source&&(0,o.jsx)("span",{className:"px-2 py-0.5 text-xs bg-indigo-50 text-indigo-600 rounded-full",children:"AI"})]}),t.model_number&&(0,o.jsx)("p",{className:"text-sm text-gray-500 mt-0.5",children:t.model_number}),t.specs_summary&&(0,o.jsx)("p",{className:"text-xs text-gray-400 mt-1 line-clamp-1",children:t.specs_summary}),(0,o.jsxs)("p",{className:"text-xs text-gray-400 mt-2",children:["Added ",function(e){let t=new Date(e).getTime(),r=Date.now()-t,s=Math.floor(r/6e4),a=Math.floor(r/36e5),o=Math.floor(r/864e5);return s<1?"Just now":s<60?"".concat(s,"m ago"):a<24?"".concat(a,"h ago"):o<7?"".concat(o,"d ago"):new Date(t).toLocaleDateString()}(t.added_at)]})]}),(0,o.jsxs)("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[s&&(0,o.jsx)("button",{onClick:()=>s(t.id),className:"p-2 text-gray-400 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),(0,o.jsx)("button",{onClick:()=>r(t.id),className:"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"Remove from list",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})}function J(e){let{onSwitchToDiscover:t,onSearchStarted:r,country:s}=e,{items:a,removeItem:l,clearList:i,addItem:c,startPriceSearch:d,isSearching:u}=z(),[h,m]=(0,n.useState)(!1),[g,x]=(0,n.useState)(""),[p,f]=(0,n.useState)(""),[y,v]=(0,n.useState)(null),b=(0,n.useCallback)(e=>{e.preventDefault(),g.trim()&&(c({product_name:g.trim(),model_number:p.trim()||void 0,source:"manual"}),x(""),f(""),m(!1))},[g,p,c]),j=(0,n.useCallback)(()=>{window.confirm("Are you sure you want to clear your entire shopping list?")&&i()},[i]),N=(0,n.useCallback)(async()=>{v(null);try{await d(s),null==r||r()}catch(e){v(e instanceof Error?e.message:"Failed to start search")}},[d,s,r]);return(0,o.jsxs)("div",{className:"space-y-6",children:[(0,o.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-6",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("h2",{className:"text-xl font-semibold text-gray-800",children:"Shopping List"}),(0,o.jsx)("p",{className:"text-gray-500 text-sm mt-1",children:0===a.length?"Add products to compare prices":"".concat(a.length," item").concat(1!==a.length?"s":""," in your list")})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsxs)("button",{onClick:()=>m(!h),className:"px-3 py-1.5 text-sm bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors flex items-center gap-1",children:[(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Add Manually"]}),a.length>0&&(0,o.jsx)("button",{onClick:j,className:"px-3 py-1.5 text-sm text-gray-400 hover:text-red-400 transition-colors",children:"Clear All"})]})]}),h&&(0,o.jsxs)("form",{onSubmit:b,className:"mt-4 p-4 bg-gray-50 rounded-lg space-y-3",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{className:"block text-sm text-gray-500 mb-1",children:"Product Name *"}),(0,o.jsx)("input",{type:"text",value:g,onChange:e=>x(e.target.value),placeholder:"e.g., Samsung Refrigerator",className:"w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-500 transition-colors",autoFocus:!0})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{className:"block text-sm text-gray-500 mb-1",children:"Model Number (optional)"}),(0,o.jsx)("input",{type:"text",value:p,onChange:e=>f(e.target.value),placeholder:"e.g., RF72DG9620B1",className:"w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-500 transition-colors"})]}),(0,o.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,o.jsx)("button",{type:"button",onClick:()=>m(!1),className:"px-3 py-1.5 text-sm text-gray-500 hover:text-gray-800 transition-colors",children:"Cancel"}),(0,o.jsx)("button",{type:"submit",disabled:!g.trim(),className:"px-4 py-1.5 text-sm bg-indigo-500 text-white rounded-lg hover:bg-indigo-400 disabled:bg-gray-200 disabled:text-gray-400 transition-colors",children:"Add to List"})]})]})]}),0===a.length?(0,o.jsxs)("div",{className:"bg-white/30 border border-gray-200 rounded-xl p-12 text-center",children:[(0,o.jsx)("svg",{className:"w-16 h-16 mx-auto text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,o.jsx)("p",{className:"text-gray-500 mb-2",children:"Your shopping list is empty"}),(0,o.jsx)("p",{className:"text-gray-400 text-sm mb-4",children:'Use "Find Products" to discover products with AI, or add items manually'}),(0,o.jsx)("button",{onClick:t,className:"px-4 py-2 bg-cyan-500/20 text-indigo-600 hover:bg-cyan-500 hover:text-gray-800 rounded-lg transition-colors text-sm",children:"Find Products with AI"})]}):(0,o.jsxs)("div",{className:"space-y-3",children:[a.map(e=>(0,o.jsx)(H,{item:e,onRemove:l},e.id)),(0,o.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[y&&(0,o.jsx)("div",{className:"mb-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:y}),(0,o.jsx)("button",{onClick:N,disabled:u,className:"w-full py-3 bg-gradient-to-r from-indigo-500 to-blue-500\n                       text-white font-medium rounded-xl\n                       flex items-center justify-center gap-2 transition-all\n                       ".concat(u?"opacity-75 cursor-wait":"hover:from-indigo-400 hover:to-blue-400"),children:u?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("svg",{className:"w-5 h-5 animate-spin",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Searching prices..."]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),"Search Prices for All Items"]})}),(0,o.jsx)("p",{className:"text-center text-gray-400 text-xs mt-2",children:u?"You can continue browsing while we search":"We'll search all your items at once and notify you when done"})]})]})]})}function U(e){let{onViewResults:t}=e,{activeSearchSession:r,isSearching:s}=z(),[a,l]=(0,n.useState)(!1),[i,c]=(0,n.useState)(!1);if((0,n.useEffect)(()=>{if((null==r?void 0:r.status)==="completed"&&!s){l(!0),c(!0);let e=setTimeout(()=>{l(!1)},1e4);return()=>clearTimeout(e)}},[null==r?void 0:r.status,s]),s&&r)return(0,o.jsx)("div",{className:"fixed bottom-20 right-4 z-50 animate-slide-in",children:(0,o.jsx)("div",{className:"bg-white border border-gray-200 rounded-xl shadow-lg p-4 max-w-sm",children:(0,o.jsxs)("div",{className:"flex items-center gap-3",children:[(0,o.jsx)("div",{className:"flex-shrink-0",children:(0,o.jsxs)("svg",{className:"w-5 h-5 text-indigo-500 animate-spin",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]})}),(0,o.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,o.jsx)("p",{className:"text-gray-800 text-sm font-medium",children:"Searching prices..."}),(0,o.jsx)("p",{className:"text-gray-500 text-xs truncate",children:"You can continue browsing while we search"})]})]})})});if(!a||!r)return null;let d="completed"===r.status,u="failed"===r.status;return(0,o.jsx)("div",{className:"fixed bottom-20 right-4 z-50 animate-slide-in",children:(0,o.jsxs)("div",{className:"bg-white border rounded-xl shadow-lg p-4 max-w-sm ".concat(d?"border-emerald-300":u?"border-red-300":"border-gray-200"),children:[(0,o.jsxs)("div",{className:"flex items-start gap-3",children:[(0,o.jsx)("div",{className:"flex-shrink-0 mt-0.5",children:d?(0,o.jsx)("svg",{className:"w-5 h-5 text-emerald-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}):(0,o.jsx)("svg",{className:"w-5 h-5 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,o.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,o.jsx)("p",{className:"text-sm font-medium ".concat(d?"text-emerald-600":"text-red-600"),children:d?"Price search complete!":"Price search failed"}),d?(0,o.jsx)("p",{className:"text-gray-500 text-xs mt-0.5",children:"Click to view results in the dashboard"}):(0,o.jsx)("p",{className:"text-gray-400 text-xs mt-0.5 line-clamp-2",children:r.error||"An error occurred"})]}),(0,o.jsx)("button",{onClick:()=>l(!1),className:"flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),d&&r.trace_id&&(0,o.jsx)("button",{onClick:()=>{t(r.trace_id),l(!1),c(!1)},className:"mt-3 w-full py-2 bg-emerald-50 text-emerald-600 text-sm rounded-lg hover:bg-emerald-500 hover:text-white transition-colors",children:"View Results"})]})})}let V="priceagent_user_country";function q(e){try{let t={country:e,timestamp:Date.now()};localStorage.setItem(V,JSON.stringify(t))}catch(e){console.error("[Country] Failed to cache:",e)}}function G(e){return e.toLowerCase().replace(/[|]/g," ").replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim()}function Y(e){return e.toLowerCase().replace(/[^\w]/g,"")}function $(){return(0,o.jsx)(n.Suspense,{fallback:(0,o.jsx)(Q,{}),children:(0,o.jsx)(Z,{})})}function Q(){return(0,o.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 flex items-center justify-center",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("h1",{className:"text-4xl font-bold bg-gradient-to-r from-indigo-500 via-blue-500 to-teal-500 bg-clip-text text-transparent",children:"Shopping Agent"}),(0,o.jsx)("p",{className:"text-gray-500 mt-4 animate-pulse",children:"Loading..."})]})})}function Z(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),r=()=>{let e=t.get("tab");return"search"===e||"discover"===e||"shopping-list"===e?e:t.get("trace")?"search":"discover"},[s,a]=(0,n.useState)(r),i=r=>{a(r);let s=new URLSearchParams(t.toString());s.set("tab",r),s.delete("trace"),e.push("/?".concat(s.toString()),{scroll:!1}),"discover"===r&&E()};(0,n.useEffect)(()=>{let e=r();e!==s&&a(e)},[t]);let{country:c,setCountry:d}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"IL",[t,r]=(0,n.useState)(e),[s,a]=(0,n.useState)(!0),[o,l]=(0,n.useState)(null),i=(0,n.useCallback)(async()=>{a(!0),l(null);let e=function(){try{let e=localStorage.getItem(V);if(!e)return null;let t=JSON.parse(e);if(Date.now()-t.timestamp<6048e5)return t.country;return localStorage.removeItem(V),null}catch(e){return null}}();if(e){r(e),a(!1);return}try{let e=await k.h.getCountry();r(e.country),q(e.country)}catch(e){console.error("[Country] Detection failed:",e),l("Could not detect country")}finally{a(!1)}},[]);return(0,n.useEffect)(()=>{i()},[i]),{country:t,isLoading:s,error:o,setCountry:(0,n.useCallback)(e=>{r(e),q(e)},[]),refresh:i}}("IL"),{showDashboardLink:u}=function(){let[e,t]=(0,n.useState)(!1),[r,s]=(0,n.useState)(!0);return(0,n.useEffect)(()=>{(async()=>{try{let e=await fetch("".concat("","/traces/auth/info")),r=await e.json();t(!r.auth_required)}catch(e){t(!0)}finally{s(!1)}})()},[]),{showDashboardLink:e,isLoading:r}}(),{items:m,addItem:p,activeSearchSession:f,markSearchComplete:y}=z(),{history:C,currentTraceId:L,loadHistory:D,loadFromTrace:M,deleteFromHistory:F,clearResults:E}=I(),[P,W]=(0,n.useState)(""),[R,T]=(0,n.useState)(null),[A,O]=(0,n.useState)(!1),[H,$]=(0,n.useState)(!1),[Q,Z]=(0,n.useState)([]),[ee,es]=(0,n.useState)([]),[ea,eo]=(0,n.useState)([]),[en,el]=(0,n.useState)(null),[ei,ec]=(0,n.useState)(null),[ed,eu]=(0,n.useState)(0),[eh,em]=(0,n.useState)(null),[eg,ex]=(0,n.useState)(null),[ep,ef]=(0,n.useState)([]),[ey,ev]=(0,n.useState)({}),[eb,ej]=(0,n.useState)({}),[eN,ew]=(0,n.useState)({}),{generateDrafts:ek,isGenerating:eS}=(0,S.z)();(0,n.useEffect)(()=>{ef(v()),D()},[D]),(0,n.useEffect)(()=>{if(!(null==f?void 0:f.trace_id)||"running"!==f.status)return;let e=f.trace_id,t="".concat("https:"===window.location.protocol?"wss:":"ws:","//").concat(window.location.host),r=null,s=()=>{r&&(r.close(),r=null)};try{(r=new WebSocket("".concat(t,"/traces/ws"))).onmessage=t=>{try{let a=JSON.parse(t.data);if(a.trace_id!==e)return;if("trace_ended"===a.event_type){var r;if(console.log("[PriceSearch] Trace completed:",e),null===(r=a.data)||void 0===r?void 0:r.error)y("failed",a.data.error);else if(y("completed"),m.length>0){let t=m.map(e=>e.product_name).join(", "),r=b({query:t,timestamp:Date.now(),resultCount:m.length,searchTimeMs:0,traceId:e,status:"completed"});ef(e=>[r,...e.slice(0,49)]),console.log("[PriceSearch] Added to history:",r.id)}s()}}catch(e){}},r.onerror=()=>{console.error("[PriceSearch] WebSocket error"),y("failed","Connection error"),s()}}catch(e){console.error("[PriceSearch] Failed to connect WebSocket:",e)}return s},[null==f?void 0:f.trace_id,null==f?void 0:f.status,y,m]),(0,n.useEffect)(()=>{k.h.getSellers().then(e=>{let t={},r={},s={};e.forEach(e=>{let a=e.whatsapp_number||e.phone_number;a&&(e.domain&&(t[e.domain]=a),r[G(e.seller_name)]=a,s[Y(e.seller_name)]=a)}),ev(t),ej(r),ew(s),console.log("[Sellers] Loaded",e.length,"sellers for enrichment")}).catch(e=>{console.error("[Sellers] Failed to load sellers:",e)})},[]),(0,n.useEffect)(()=>{g("/")},[]);let e_=(0,n.useCallback)((e,t)=>{if(t){let e=function(e){try{let t=new URL(e).hostname.toLowerCase();if(t.startsWith("www.")&&(t=t.slice(4)),t.includes("google.com"))return null;return t}catch(e){return null}}(t);if(e&&ey[e])return ey[e]}let r=G(e);if(eb[r])return eb[r];for(let[e,t]of Object.entries(eb))if(r.includes(e)||e.includes(r))return t;let s=Y(e);if(eN[s])return eN[s];for(let[e,t]of Object.entries(eN))if(s.includes(e)||e.includes(s))return t},[ey,eb,eN]),eC=(0,n.useCallback)(e=>e.map(e=>({...e,results:e.results.map(e=>{if(e.phone)return e;let t=e_(e.seller,e.url);return t?{...e,phone:t}:e})})),[e_]),eL=(0,n.useCallback)(e=>e.map(e=>{var t,r;if(e.contact)return e;let s=e_(e.storeName,null===(r=e.products)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.url);return s?{...e,contact:s}:e}),[e_]),eD=Object.keys(ey).length>0||Object.keys(eb).length>0;(0,n.useEffect)(()=>{eD&&Q.length>0&&Q.some(e=>e.results.some(e=>!e.phone&&(e.url||e.seller)))&&(console.log("[Enrichment] Re-enriching results with seller data"),Z(e=>eC(e))),eD&&ee.length>0&&ee.some(e=>{var t,r;return!e.contact&&(e.storeName||(null===(r=e.products)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.url))})&&(console.log("[Enrichment] Re-enriching bundles with seller data"),es(e=>eL(e)))},[eD]),(0,n.useEffect)(()=>{let e=t.get("trace");e&&e!==R?eI(e):!e&&R&&(T(null),Z([]),es([]),eo([]),ex(null),W(""))},[t]);let eI=async t=>{console.log("[LoadTrace] Starting load for trace:",t),$(!0),el(null),Z([]),es([]),eo([]),ex(null);try{var r;console.log("[LoadTrace] Fetching from:","".concat("","/traces/").concat(t));let e=await fetch("".concat("","/traces/").concat(t));if(!e.ok)throw console.error("[LoadTrace] Response not ok:",e.status),Error("Trace not found");let s=await e.json();if(console.log("[LoadTrace] Got trace:",s.status,"has final_output:",!!s.final_output,"spans:",null===(r=s.spans)||void 0===r?void 0:r.length),"completed"===s.status){W(s.input_prompt.replace("Search for: ","")),T(t),ec(s.total_duration_ms);let e=(s.spans||[]).filter(e=>"tool_call"===e.span_type&&("search_products"===e.tool_name||"search_multiple_products"===e.tool_name||"search_aggregators"===e.tool_name)&&e.tool_output);if(console.log("[LoadTrace] Found search spans:",e.length),e.length>0){let t=[];for(let r of e){let e;let s=r.tool_output;ex(s);let a=/\n=== ([^=\n]+) ===\n/g,o=[];for(;null!==(e=a.exec(s));)e[1].includes("BUNDLE")||o.push({name:e[1].trim(),startIndex:e.index+e[0].length});if(o.length>0)for(let e=0;e<o.length;e++){let r=o[e].startIndex,a=e+1<o.length?s.indexOf("\n===",r):s.length,n=s.slice(r,a>0?a:void 0),l=et(n);l.length>0&&t.push({productName:o[e].name,results:l})}else{let e="Search Results";if(r.tool_input)try{let t="string"==typeof r.tool_input?JSON.parse(r.tool_input):r.tool_input;t.query&&(e=t.query)}catch(e){}let a=et(s);a.length>0&&t.push({productName:e,results:a})}let n=er(s);n.length>0&&(es(eL(n)),console.log("[LoadTrace] Found bundles:",n.length))}Z(eC(t)),console.log("[LoadTrace] Parsed results:",t.length,"products")}else if(s.final_output){ex(s.final_output);let e=X(s.final_output);Z(eC(e)),console.log("[LoadTrace] Parsed from final_output:",e.length)}else el("Search completed but no results found")}else"error"===s.status?el(s.error||"Search failed"):"running"===s.status?el("This search is still running. Please wait..."):(console.log("[LoadTrace] Unknown status:",s.status),el("Could not load results"))}catch(t){console.error("[LoadTrace] Error:",t),el("Could not load search results"),e.replace("/",{scroll:!1})}finally{$(!1)}},eM=t=>{let r="/?trace=".concat(t);e.replace(r,{scroll:!1}),T(t)};(0,n.useEffect)(()=>{let e=null;return A&&(eu(0),e=setInterval(()=>{eu(e=>e+1)},1e3)),()=>{e&&clearInterval(e)}},[A]);let eF=(e,t)=>new Promise((r,s)=>{let a=t.replace("http://","ws://").replace("https://","wss://")||"".concat("https:"===window.location.protocol?"wss:":"ws:","//").concat(window.location.host),o=new WebSocket("".concat(a,"/traces/ws")),n=!1,l=()=>{o.readyState===WebSocket.OPEN&&o.close()};o.onopen=()=>{em("Connected, waiting for results...")},o.onmessage=async t=>{try{var a,o,i,c,d,u;let h=JSON.parse(t.data);if(h.trace_id!==e)return;if("span_started"===h.event_type||"span_ended"===h.event_type){let e=(null===(a=h.data)||void 0===a?void 0:a.name)||"",t=(null===(o=h.data)||void 0===o?void 0:o.type)||(null===(i=h.data)||void 0===i?void 0:i.span_type)||"",r=e;e.includes("search_products")||e.includes("search_aggregators")?r="\uD83D\uDD0D Searching price comparison sites...":e.includes("google_shopping")||e.includes("GoogleShopping")?r="\uD83D\uDED2 Searching Google Shopping...":e.includes("google_search")||e.includes("GoogleSearch")?r="\uD83D\uDD0E Searching Google...":e.includes("zap")||e.includes("Zap")?r="\uD83C\uDFEA Searching Zap.co.il...":e.includes("wisebuy")||e.includes("WiseBuy")?r="\uD83D\uDCA1 Searching WiseBuy...":e.includes("extract")||e.includes("scrape")?r="\uD83D\uDCC4 Extracting product details...":"llm_call"===t?r="\uD83E\uDD16 AI is analyzing results...":"agent"===t||"agent_run"===t?r="\uD83D\uDD04 Processing...":e&&(r=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())),em(r)}"trace_ended"===h.event_type&&(n=!0,l(),console.log("[WebSocket] trace_ended received:",h),console.log("[WebSocket] final_output:",null===(c=h.data)||void 0===c?void 0:c.final_output),(null===(d=h.data)||void 0===d?void 0:d.error)?s(Error(h.data.error)):r((null===(u=h.data)||void 0===u?void 0:u.final_output)||""))}catch(e){console.error("WebSocket message parse error:",e)}},o.onerror=()=>{n||(l(),s(Error("WebSocket connection failed")))},o.onclose=()=>{n||fetch("".concat(t,"/traces/").concat(e)).then(e=>e.json()).then(e=>{"completed"===e.status?r(e.final_output||""):"error"===e.status?s(Error(e.error||"Search failed")):s(Error("Connection lost. Check the dashboard for results."))}).catch(()=>s(Error("Connection lost. Check the dashboard for results.")))}}),eE=(0,n.useCallback)(async e=>{if(e.preventDefault(),!P.trim()||A)return;O(!0),el(null),Z([]),es([]),eo([]),ex(null),em("Starting search...");let t=Date.now();try{let e=await fetch("".concat("","/agent/run"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agent:"research",query:P})});if(!e.ok)throw Error("Failed to start search. Please try again.");let{trace_id:a}=await e.json(),o=b({query:P,timestamp:Date.now(),resultCount:0,searchTimeMs:0,traceId:a,status:"searching"});ef(e=>[o,...e.filter(e=>e.traceId!==a).slice(0,49)]),await eF(a,"");let n=Date.now()-t;ec(n),em(null),eM(a);let l=await fetch("".concat("","/traces/").concat(a));if(l.ok){var r,s;let e=await l.json(),t=(e.spans||[]).filter(e=>"tool_call"===e.span_type&&("search_products"===e.tool_name||"search_multiple_products"===e.tool_name)&&e.tool_output);if(t.length>0){let e=[];for(let r of t){let t;let s=r.tool_output;ex(s);let a=/\n=== ([^=\n]+) ===\n/g,o=[];for(;null!==(t=a.exec(s));)t[1].includes("BUNDLE")||o.push({name:t[1].trim(),startIndex:t.index+t[0].length});if(o.length>0)for(let t=0;t<o.length;t++){let r=o[t].startIndex,a=t+1<o.length?s.indexOf("\n===",r):s.length,n=s.slice(r,a>0?a:void 0),l=et(n);l.length>0&&e.push({productName:o[t].name,results:l})}else{let t=P;if(r.tool_input)try{let e="string"==typeof r.tool_input?JSON.parse(r.tool_input):r.tool_input;e.query&&(t=e.query)}catch(e){}let a=et(s);a.length>0&&e.push({productName:t,results:a})}let n=er(s);n.length>0&&(es(eL(n)),console.log("[Search] Found bundles:",n.length))}Z(eC(e)),console.log("[Search] Parsed from tool output:",e.length,"products");let s=e.reduce((e,t)=>e+t.results.length,0);x(P,s,n),j(a,{status:"completed",resultCount:s,searchTimeMs:n,topResults:null===(r=e[0])||void 0===r?void 0:r.results.slice(0,3).map(e=>({seller:e.seller,price:e.price,currency:e.currency}))}),ef(e=>e.map(e=>e.traceId===a?{...e,status:"completed",resultCount:s,searchTimeMs:n}:e))}else if(e.final_output){ex(e.final_output);let t=X(e.final_output);Z(eC(t));let r=t.reduce((e,t)=>e+t.results.length,0);x(P,r,n),j(a,{status:"completed",resultCount:r,searchTimeMs:n,topResults:null===(s=t[0])||void 0===s?void 0:s.results.slice(0,3).map(e=>({seller:e.seller,price:e.price,currency:e.currency}))}),ef(e=>e.map(e=>e.traceId===a?{...e,status:"completed",resultCount:r,searchTimeMs:n}:e))}}}catch(e){el(e instanceof Error?e.message:"An error occurred"),em(null)}finally{O(!1)}},[P,A]),eP=async t=>{if(console.log("[LocalHistory] Clicked item:",t.id,t.query,"traceId:",t.traceId),a("search"),W(t.query),t.traceId){let r=new URLSearchParams;r.set("tab","search"),r.set("trace",t.traceId),e.push("/?".concat(r.toString()),{scroll:!1}),eI(t.traceId);return}i("search")},eW=t=>{if(console.log("[DiscoveryHistory] Clicked item:",t.id,t.query,"traceId:",t.traceId),t.traceId){let r=new URLSearchParams;r.set("tab","discover"),r.set("trace",t.traceId),e.push("/?".concat(r.toString()),{scroll:!1}),M(t.traceId,t.query)}else i("discover")},eB=e=>{eo(t=>t.find(t=>t.id===e.id)?t.filter(t=>t.id!==e.id):[...t,e])},eR=e=>ea.some(t=>t.id===e),eT=(e,t)=>{h("contact","whatsapp",{label:e,data:{product:P}});let r=t.replace(/[^0-9+]/g,""),s=encodeURIComponent("Hi, I'm interested in ".concat(P,". What's your best price?"));window.open("https://wa.me/".concat(r,"?text=").concat(s),"_blank")},eA=(0,n.useCallback)(e=>{console.log("[ShoppingList] Added item:",p(e).product_name)},[p]);return(0,o.jsxs)("div",{className:"min-h-screen bg-gray-50 flex flex-col md:flex-row",children:[(0,o.jsx)("header",{className:"md:hidden bg-white border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 z-50",children:(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsxs)("svg",{className:"w-8 h-8",viewBox:"0 0 64 64",fill:"none",children:[(0,o.jsx)("path",{d:"M12 20 L8 58 C8 60 10 62 12 62 L52 62 C54 62 56 60 56 58 L52 20 Z",fill:"#818CF8",stroke:"#6366f1",strokeWidth:"2"}),(0,o.jsx)("path",{d:"M22 20 C22 12 26 6 32 6 C38 6 42 12 42 20",fill:"none",stroke:"#6366f1",strokeWidth:"3",strokeLinecap:"round"}),(0,o.jsx)("circle",{cx:"24",cy:"36",r:"4",fill:"#34D399"}),(0,o.jsx)("circle",{cx:"40",cy:"36",r:"4",fill:"#34D399"}),(0,o.jsx)("path",{d:"M24 46 Q32 52 40 46",fill:"none",stroke:"#34D399",strokeWidth:"2",strokeLinecap:"round"})]}),(0,o.jsx)("h1",{className:"text-lg font-bold text-gray-800",children:"Shopping Agent"})]})}),(0,o.jsxs)("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex z-50",children:[(0,o.jsxs)("button",{onClick:()=>i("discover"),className:"flex-1 flex flex-col items-center py-3 ".concat("discover"===s?"text-indigo-600":"text-gray-500"),children:[(0,o.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,o.jsx)("span",{className:"text-xs mt-1",children:"Find"})]}),(0,o.jsxs)("button",{onClick:()=>i("search"),className:"flex-1 flex flex-col items-center py-3 ".concat("search"===s?"text-indigo-600":"text-gray-500"),children:[(0,o.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,o.jsx)("span",{className:"text-xs mt-1",children:"Prices"})]}),(0,o.jsxs)("button",{onClick:()=>i("shopping-list"),className:"flex-1 flex flex-col items-center py-3 relative ".concat("shopping-list"===s?"text-indigo-600":"text-gray-500"),children:[(0,o.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,o.jsx)("span",{className:"text-xs mt-1",children:"List"}),m.length>0&&(0,o.jsx)("span",{className:"absolute top-1 right-1/4 w-5 h-5 text-xs bg-indigo-500 text-gray-800 rounded-full flex items-center justify-center",children:m.length})]})]}),(0,o.jsxs)("aside",{className:"hidden md:flex fixed top-0 left-0 h-full w-64 bg-white border-r border-gray-200 flex-col z-40 shadow-soft",children:[(0,o.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,o.jsxs)("div",{className:"flex items-center gap-3 mb-3",children:[(0,o.jsx)("div",{className:"w-10 h-10 flex items-center justify-center",children:(0,o.jsxs)("svg",{className:"w-10 h-10",viewBox:"0 0 64 64",fill:"none",children:[(0,o.jsx)("path",{d:"M12 20 L8 58 C8 60 10 62 12 62 L52 62 C54 62 56 60 56 58 L52 20 Z",fill:"#818CF8",stroke:"#6366f1",strokeWidth:"2"}),(0,o.jsx)("path",{d:"M22 20 C22 12 26 6 32 6 C38 6 42 12 42 20",fill:"none",stroke:"#6366f1",strokeWidth:"3",strokeLinecap:"round"}),(0,o.jsx)("circle",{cx:"24",cy:"36",r:"5",fill:"#34D399"}),(0,o.jsx)("circle",{cx:"24",cy:"36",r:"2",fill:"#059669"}),(0,o.jsx)("circle",{cx:"40",cy:"36",r:"5",fill:"#34D399"}),(0,o.jsx)("circle",{cx:"40",cy:"36",r:"2",fill:"#059669"}),(0,o.jsx)("path",{d:"M24 46 Q32 54 40 46",fill:"none",stroke:"#34D399",strokeWidth:"2.5",strokeLinecap:"round"}),(0,o.jsx)("circle",{cx:"32",cy:"4",r:"3",fill:"#34D399"}),(0,o.jsx)("line",{x1:"32",y1:"6",x2:"32",y2:"12",stroke:"#34D399",strokeWidth:"2"})]})}),(0,o.jsx)("div",{children:(0,o.jsx)("h1",{className:"text-lg font-bold text-gray-800",children:"Shopping Agent"})})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[(0,o.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"currentColor",children:(0,o.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"})}),(0,o.jsx)("span",{children:"Built by Yonigo"})]})]}),(0,o.jsxs)("nav",{className:"p-3 space-y-1 border-b border-gray-200",children:[(0,o.jsxs)("button",{onClick:()=>i("discover"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("discover"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,o.jsx)("span",{className:"font-medium",children:"Find Products"})]}),(0,o.jsxs)("button",{onClick:()=>i("search"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("search"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,o.jsx)("span",{className:"font-medium",children:"Price Search"})]}),(0,o.jsxs)("button",{onClick:()=>i("shopping-list"),className:"w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors text-left ".concat("shopping-list"===s?"bg-indigo-50 text-indigo-600 border border-indigo-200":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"),children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),(0,o.jsx)("span",{className:"font-medium",children:"Shopping List"}),m.length>0&&(0,o.jsx)("span",{className:"ml-auto w-5 h-5 text-xs flex items-center justify-center rounded-full ".concat("shopping-list"===s?"bg-indigo-200 text-indigo-700":"bg-indigo-100 text-indigo-600"),children:m.length})]})]}),(0,o.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,o.jsxs)("div",{className:"p-3",children:[(0,o.jsx)("h3",{className:"text-xs font-medium text-gray-400 uppercase tracking-wider mb-2",children:"discover"===s?"Discovery History":"search"===s?"Search History":"Recent Searches"}),"search"===s?0===ep.length?(0,o.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,o.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,o.jsx)("p",{className:"text-xs",children:"No search history"})]}):(0,o.jsx)("div",{className:"space-y-1",children:ep.slice(0,10).map(e=>{let t=e.traceId===R;return(0,o.jsxs)("div",{className:"relative group",children:[(0,o.jsxs)("button",{onClick:()=>eP(e),className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":"hover:bg-white"),children:[(0,o.jsx)("p",{className:"text-sm truncate pr-6 ".concat(t?"text-indigo-700 font-medium":"text-gray-800"),children:e.query}),(0,o.jsx)("p",{className:"text-xs text-gray-400",children:w(e.timestamp)})]}),(0,o.jsx)("button",{"data-testid":"delete-history-item",onClick:t=>{t.stopPropagation(),N(e.id),ef(t=>t.filter(t=>t.id!==e.id))},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})}):"discover"===s?0===C.length?(0,o.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,o.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,o.jsx)("p",{className:"text-xs",children:"No discovery history"})]}):(0,o.jsx)("div",{className:"space-y-1",children:C.slice(0,10).map(e=>{let t=e.traceId===L,r="searching"===e.status,s="error"===e.status;return(0,o.jsxs)("div",{className:"relative group",children:[(0,o.jsxs)("button",{onClick:()=>!r&&eW(e),disabled:r,className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":r?"bg-amber-50 border border-amber-200":s?"bg-red-50 border border-red-200":"hover:bg-white"," ").concat(r?"cursor-wait":""),children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[r&&(0,o.jsxs)("svg",{className:"w-3 h-3 animate-spin text-amber-500 flex-shrink-0",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"completed"===e.status&&(0,o.jsx)("svg",{className:"w-3 h-3 text-emerald-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),s&&(0,o.jsx)("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,o.jsx)("p",{className:"text-sm truncate pr-6 ".concat(t?"text-indigo-700 font-medium":r?"text-amber-700":s?"text-red-700":"text-gray-800"),children:e.query})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400 ml-5",children:[(0,o.jsx)("span",{children:w(e.timestamp)}),r&&(0,o.jsx)("span",{className:"text-amber-500",children:"Searching..."}),"completed"===e.status&&e.productCount>0&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{children:"-"}),(0,o.jsxs)("span",{children:[e.productCount," products"]})]}),s&&(0,o.jsx)("span",{className:"text-red-500",children:"Failed"})]})]}),!r&&(0,o.jsx)("button",{onClick:t=>{t.stopPropagation(),F(e.id)},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})}):0===ep.length?(0,o.jsxs)("div",{className:"text-center text-gray-400 py-4",children:[(0,o.jsx)("svg",{className:"w-8 h-8 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,o.jsx)("p",{className:"text-xs",children:"No recent price searches"})]}):(0,o.jsx)("div",{className:"space-y-1",children:ep.slice(0,5).map(e=>{let t=e.traceId===R,r="searching"===e.status,s="error"===e.status;return(0,o.jsxs)("div",{className:"relative group",children:[(0,o.jsxs)("button",{onClick:()=>!r&&eP(e),disabled:r,className:"w-full text-left p-2 rounded-lg transition-colors ".concat(t?"bg-indigo-50 border border-indigo-200":r?"bg-amber-50 border border-amber-200":s?"bg-red-50 border border-red-200":"hover:bg-white"," ").concat(r?"cursor-wait":""),children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[r&&(0,o.jsxs)("svg",{className:"w-3 h-3 animate-spin text-amber-500 flex-shrink-0",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"completed"===e.status&&(0,o.jsx)("svg",{className:"w-3 h-3 text-emerald-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),s&&(0,o.jsx)("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,o.jsx)("p",{className:"text-sm truncate ".concat(t?"text-indigo-700 font-medium":r?"text-amber-700":s?"text-red-700":"text-gray-800"),children:e.query})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400 ml-5",children:[(0,o.jsx)("span",{children:w(e.timestamp)}),r&&(0,o.jsx)("span",{className:"text-amber-500",children:"Searching..."}),"completed"===e.status&&e.resultCount>0&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{children:"-"}),(0,o.jsxs)("span",{children:[e.resultCount," results"]})]}),s&&(0,o.jsx)("span",{className:"text-red-500",children:"Failed"})]})]}),!r&&(0,o.jsx)("button",{onClick:t=>{t.stopPropagation(),N(e.id),ef(t=>t.filter(t=>t.id!==e.id))},className:"absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete",children:(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},e.id)})})]})}),u&&(0,o.jsx)("div",{className:"p-3 border-t border-gray-200",children:(0,o.jsxs)("a",{href:"/dashboard",className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-500 hover:text-gray-800 hover:bg-white rounded-lg transition-colors",children:[(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),"Dashboard"]})})]}),(0,o.jsxs)("main",{className:"flex-1 md:ml-64 min-h-screen pb-20 md:pb-0",children:["search"===s&&(0,o.jsx)("div",{className:"p-4 md:p-8",children:(0,o.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,o.jsxs)("form",{onSubmit:eE,className:"relative",children:[(0,o.jsxs)("div",{className:"relative group",children:[(0,o.jsx)("input",{type:"text",value:P,onChange:e=>W(e.target.value),placeholder:"Search for products (e.g., Samsung refrigerator RF72DG9620B1)",className:"w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg bg-white shadow-soft border border-gray-200 rounded-xl md:rounded-2xl text-gray-800 placeholder-gray-400 outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 transition-all duration-300",disabled:A}),(0,o.jsx)("button",{type:"submit",disabled:A||!P.trim(),className:"absolute right-2 top-1/2 -translate-y-1/2 px-4 md:px-6 py-2 bg-indigo-500 hover:bg-indigo-600 disabled:bg-gray-300 text-white font-medium rounded-lg md:rounded-xl transition-all duration-300",children:A?(0,o.jsxs)("span",{className:"flex items-center gap-2",children:[(0,o.jsxs)("svg",{className:"animate-spin h-5 w-5",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Searching..."]}):"Search"})]}),(A||H)&&(0,o.jsxs)("div",{className:"text-center mt-4 space-y-2",children:[(0,o.jsx)("div",{className:"text-gray-500 text-sm animate-pulse",children:H?"Loading results...":eh||"Starting search..."}),A&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"text-gray-400 text-xs",children:["Elapsed: ",Math.floor(ed/60),":",(ed%60).toString().padStart(2,"0")]}),ed>30&&(0,o.jsx)("div",{className:"text-gray-300 text-xs",children:"Searching multiple sources - this may take a minute"})]})]})]}),0===Q.length&&!A&&!H&&!en&&!eg&&(0,o.jsx)("div",{className:"flex flex-wrap justify-center gap-2 mt-6",children:["Samsung refrigerator","LG washing machine","Bosch oven","Apple iPhone 15"].map(e=>(0,o.jsx)("button",{onClick:()=>W(e),className:"px-4 py-2 text-sm text-gray-500 bg-white shadow-soft rounded-full hover:bg-gray-100 hover:text-gray-800 transition-colors",children:e},e))}),0===Q.length&&!A&&!H&&!en&&!eg&&ep.length>0&&(0,o.jsxs)("div",{className:"mt-8",children:[(0,o.jsx)("h3",{className:"text-sm text-gray-400 text-center mb-3",children:"Recent searches"}),(0,o.jsx)("div",{className:"flex flex-wrap justify-center gap-2",children:ep.slice(0,5).map(e=>(0,o.jsxs)("button",{onClick:()=>eP(e),className:"px-3 py-1.5 text-sm text-gray-400 bg-white/30 rounded-lg hover:bg-white hover:text-gray-600 transition-colors flex items-center gap-2",children:[(0,o.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.query]},e.id))})]}),(Q.length>0||en||eg&&!A)&&(0,o.jsx)("div",{className:"mt-8",children:en?(0,o.jsxs)("div",{className:"text-center py-12",children:[(0,o.jsx)("div",{className:"text-red-400 text-lg",children:en}),(0,o.jsx)("button",{onClick:()=>el(null),className:"mt-4 text-indigo-600 hover:underline",children:"Try again"})]}):Q.length>0?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,o.jsxs)("div",{className:"text-gray-500",children:["Found ",Q.reduce((e,t)=>e+t.results.length,0)," results",ee.length>0&&" from ".concat(ee.length," bundle stores"),ei&&(0,o.jsxs)("span",{className:"text-gray-300",children:[" in ",(ei/1e3).toFixed(1),"s"]})]}),u&&(0,o.jsx)("a",{href:"/dashboard",className:"text-sm text-indigo-600 hover:underline",children:"Advanced view →"})]}),ee.length>0&&(0,o.jsxs)("div",{className:"mb-8 bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-4",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold text-amber-600 mb-4 flex items-center gap-2",children:[(0,o.jsx)("span",{children:"Bundle Opportunities"}),(0,o.jsx)("span",{className:"text-sm font-normal text-amber-600/70",children:"- Stores with multiple products"})]}),(0,o.jsx)("div",{className:"overflow-x-auto",children:(0,o.jsxs)("table",{className:"w-full text-sm",children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{className:"text-left text-gray-500 border-b border-gray-200",children:[(0,o.jsx)("th",{className:"pb-3 font-medium w-10",children:"Select"}),(0,o.jsx)("th",{className:"pb-3 font-medium",children:"Store"}),(0,o.jsx)("th",{className:"pb-3 font-medium",children:"Rating"}),(0,o.jsx)("th",{className:"pb-3 font-medium",children:"Products"}),(0,o.jsx)("th",{className:"pb-3 font-medium",children:"Total"}),(0,o.jsx)("th",{className:"pb-3 font-medium",children:"Contact"})]})}),(0,o.jsx)("tbody",{children:ee.map((e,t)=>{let r="bundle-".concat(e.storeName,"-").concat(t),s=eR(r),a=!!e.contact;return(0,o.jsxs)("tr",{className:"border-b border-gray-200/50 ".concat(s?"bg-indigo-500/10":""),children:[(0,o.jsx)("td",{className:"py-3",children:a?(0,o.jsx)("button",{onClick:()=>eB({id:r,name:e.storeName,phone:e.contact,price:e.totalPrice,productName:"Bundle (".concat(e.productCount," items)")}),className:"w-5 h-5 flex items-center justify-center rounded border-2 transition-colors\n                                              ".concat(s?"bg-indigo-500 border-indigo-500 text-white":"border-gray-300 hover:border-indigo-400"),children:s&&(0,o.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):(0,o.jsx)("span",{className:"text-gray-400",children:t+1})}),(0,o.jsx)("td",{className:"py-3 text-gray-800 font-medium",children:e.storeName}),(0,o.jsx)("td",{className:"py-3",children:e.rating?(0,o.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 bg-amber-50 text-amber-600 rounded text-xs",children:["★ ",e.rating.toFixed(1)]}):"-"}),(0,o.jsx)("td",{className:"py-3",children:(0,o.jsxs)("div",{className:"space-y-1",children:[e.products.map((e,t)=>(0,o.jsxs)("div",{className:"text-xs text-gray-500",children:[e.name,": ",e.url?(0,o.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-indigo-600 hover:underline",children:["₪",e.price.toLocaleString()]}):(0,o.jsxs)("span",{className:"text-emerald-600",children:["₪",e.price.toLocaleString()]})]},t)),(0,o.jsx)("div",{className:"text-xs text-amber-600/70 italic mt-1",children:"Ask for bundle discount"})]})}),(0,o.jsxs)("td",{className:"py-3",children:[(0,o.jsxs)("div",{className:"text-emerald-600 font-bold",children:["₪",e.totalPrice.toLocaleString()]}),(0,o.jsxs)("div",{className:"text-xs text-gray-400",children:[e.productCount,"/",e.totalProducts," products"]})]}),(0,o.jsx)("td",{className:"py-3",children:e.contact?(0,o.jsxs)("button",{onClick:()=>eT(e.storeName,e.contact),className:"flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500/20 text-emerald-600 hover:bg-emerald-500 hover:text-gray-800 rounded-lg transition-colors text-xs",children:[(0,o.jsx)("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact"]}):(0,o.jsx)("span",{className:"text-gray-400 text-xs",children:"-"})})]},t)})})]})})]}),Q.map((e,t)=>(0,o.jsxs)("div",{className:"mb-8",children:[Q.length>1&&(0,o.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-4",children:e.productName}),(0,o.jsx)("div",{className:"space-y-3",children:e.results.map((t,r)=>{let s="".concat(e.productName,"-").concat(t.seller,"-").concat(r);return(0,o.jsx)(K,{result:t,rank:r+1,productName:e.productName,isSelected:eR(s),onToggleSelect:()=>t.phone&&eB({id:s,name:t.seller,phone:t.phone,price:t.price,productName:e.productName}),onContact:()=>t.phone&&eT(t.seller,t.phone)},r)})})]},t))]}):eg?(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsxs)("div",{className:"text-gray-500",children:["Search completed",ei&&(0,o.jsxs)("span",{className:"text-gray-300",children:[" in ",(ei/1e3).toFixed(1),"s"]})]}),u&&(0,o.jsx)("a",{href:"/dashboard",className:"text-sm text-indigo-600 hover:underline",children:"View in dashboard →"})]}),(0,o.jsxs)("div",{className:"bg-white shadow-soft border border-gray-200 rounded-xl p-4",children:[(0,o.jsx)("h3",{className:"text-gray-800 font-medium mb-3",children:"Agent Response"}),(0,o.jsx)("pre",{className:"text-gray-600 text-sm whitespace-pre-wrap font-mono overflow-x-auto",children:eg})]}),(0,o.jsx)("p",{className:"text-gray-400 text-sm text-center",children:"Results displayed in raw format. View the dashboard for structured data."})]}):null})]})}),"discover"===s&&(0,o.jsx)("div",{className:"p-8",children:(0,o.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,o.jsx)(B,{onAddToShoppingList:eA,country:c,onCountryChange:d})})}),"shopping-list"===s&&(0,o.jsx)("div",{className:"p-8",children:(0,o.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,o.jsx)(J,{onSwitchToDiscover:()=>i("discover"),onSearchStarted:()=>i("search"),country:c})})})]}),ea.length>0&&(0,o.jsxs)("div",{className:"fixed bottom-16 left-1/2 -translate-x-1/2 z-40 bg-white border border-gray-200 rounded-2xl shadow-2xl px-6 py-3 flex items-center gap-4",children:[(0,o.jsxs)("div",{className:"flex items-center gap-2 text-gray-800",children:[(0,o.jsx)("span",{className:"w-8 h-8 flex items-center justify-center bg-indigo-500 text-white rounded-full text-sm font-bold",children:ea.length}),(0,o.jsxs)("span",{className:"text-gray-600",children:[1===ea.length?"seller":"sellers"," selected"]})]}),(0,o.jsx)("div",{className:"w-px h-8 bg-gray-200"}),(0,o.jsx)("button",{onClick:()=>{0!==ea.length&&ek(ea.map(e=>({seller_name:e.name,phone_number:e.phone,product_name:e.productName||P,listed_price:e.price||0})))},disabled:eS,className:"flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-400 disabled:bg-emerald-500/50 disabled:cursor-wait text-gray-800 font-medium rounded-xl transition-colors",children:eS?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("svg",{className:"w-5 h-5 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,o.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,o.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Generating Messages..."]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact Sellers"]})}),(0,o.jsx)("button",{onClick:()=>{eo([])},className:"p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",title:"Clear selection",children:(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,o.jsx)("footer",{className:"fixed bottom-0 left-64 right-0 py-3 text-center text-xs text-gray-300",children:(0,o.jsx)("span",{children:"Powered by Claude AI"})}),(0,o.jsx)(_.T,{}),(0,o.jsx)(U,{onViewResults:t=>{a("search");let r=new URLSearchParams;r.set("tab","search"),r.set("trace",t),e.push("/?".concat(r.toString()),{scroll:!1}),eI(t)}})]})}function K(e){var t,r;let{result:s,rank:a,productName:n,isSelected:l,onToggleSelect:i,onContact:c}=e,d=!!s.phone;return(0,o.jsx)("div",{className:"group bg-white shadow-soft border rounded-xl p-4 transition-all duration-300\n                    ".concat(l?"border-cyan-500 bg-indigo-500/10":"border-gray-200/50 hover:border-cyan-500/30 hover:bg-white/70"),children:(0,o.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,o.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,o.jsxs)("div",{className:"flex items-center gap-3",children:[d?(0,o.jsx)("button",{onClick:i,className:"flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-md border-2 transition-colors\n                          ".concat(l?"bg-indigo-500 border-indigo-500 text-white":"border-gray-300 hover:border-indigo-400"),children:l&&(0,o.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}):(0,o.jsx)("span",{className:"flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-xs text-gray-500",children:a}),(0,o.jsxs)("div",{className:"min-w-0",children:[(0,o.jsx)("h3",{className:"font-medium text-gray-800 truncate",children:n}),(0,o.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[(0,o.jsx)("span",{children:s.seller}),s.rating&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{className:"text-gray-300",children:"•"}),(0,o.jsx)("span",{className:"text-amber-600",children:"★"}),(0,o.jsx)("span",{children:s.rating.toFixed(1)})]})]})]})]}),s.source&&(0,o.jsxs)("span",{className:"inline-block mt-2 px-2 py-0.5 text-xs text-gray-400 bg-gray-100/50 rounded",children:["via ",s.source]})]}),(0,o.jsxs)("div",{className:"flex items-center gap-4",children:[(0,o.jsx)("div",{className:"text-right",children:(0,o.jsx)("div",{className:"text-2xl font-bold text-emerald-600",children:(t=s.price,"ILS"===(r=s.currency)?"₪".concat(t.toLocaleString()):"".concat(r," ").concat(t.toLocaleString()))})}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[s.url&&(0,o.jsx)("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors",title:"View product",children:(0,o.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})}),s.phone&&(0,o.jsxs)("button",{onClick:c,className:"flex items-center gap-2 px-4 py-2 bg-emerald-500/20 text-emerald-600 hover:bg-emerald-500 hover:text-gray-800 rounded-lg transition-all duration-300",children:[(0,o.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:(0,o.jsx)("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"})}),"Contact"]})]})]})]})})}function X(e){let t;let r=[];console.log("[Parser] Parsing text:",e.substring(0,500));let s=/\n=== ([^=\n]+) ===\n/g,a=[];for(;null!==(t=s.exec(e));)t[1].includes("BUNDLE")||a.push({name:t[1].trim(),startIndex:t.index+t[0].length});if(a.length>0)for(let t=0;t<a.length;t++){let s=a[t].startIndex,o=t+1<a.length?e.indexOf("\n===",s):e.length,n=ee(e.slice(s,o>0?o:void 0));n.length>0&&r.push({productName:a[t].name,results:n})}else{let t=ee(e);t.length>0&&r.push({productName:"Search Results",results:t})}return console.log("[Parser] Parsed results:",r.length,"products"),r}function ee(e){let t=[],r=e.split("\n");console.log("[Parser] Parsing section with",r.length,"lines");for(let e=0;e<r.length;e++){let s=r[e].trim().match(/^(\d+)\.\s+(.+)/);if(s){let a,o,n,l;let i=s[2];console.log("[Parser] Found numbered line:",s[1],"-",i);let c=i,d=i.match(/\[([^\]]+)\]\s*$/);d&&(o=d[1],c=i.slice(0,i.lastIndexOf("[")).trim());let u=c.match(/\(Rating:\s*([\d.]+)\/5\)\s*$/);u&&(a=parseFloat(u[1]),c=c.slice(0,c.lastIndexOf("(")).trim()),console.log("[Parser] Extracted - seller:",c,"rating:",a,"source:",o);let h=0,m="ILS";for(let t=e+1;t<Math.min(e+7,r.length);t++){let e=r[t].trim();if(/^\d+\.\s/.test(e))break;let s=e.match(/Price:\s*([\d,]+(?:\.\d+)?)\s*(\w+)?/i);s&&console.log("[Parser] Found price:",h=parseFloat(s[1].replace(/,/g,"")),m=s[2]||"ILS");let a=e.match(/URL:\s*(https?:\/\/[^\s]+)/i);a&&(n=a[1]);let o=e.match(/Contact:\s*(\+?[\d\s-]+)/i);o&&(l=o[1].replace(/[\s-]/g,""))}h>0?(t.push({seller:c,price:h,currency:m,rating:a,url:n,phone:l,source:o}),console.log("[Parser] Added result:",c,h)):console.log("[Parser] Skipped (no price):",c)}}return console.log("[Parser] Section results:",t.length),t}function et(e){let t;let r=[],s=/(?:^|\n)(\d+)\.\s+([^\n]+)/g;for(;null!==(t=s.exec(e));){let s,a;let o=t[2],n=o.match(/(.+?)\s*\(Rating:\s*([\d.]+)\/5\)/);n?(s=n[1].trim(),a=parseFloat(n[2])):s=o.trim();let l=t.index+t[0].length,i=e.slice(l).match(/\n\d+\./),c=i&&void 0!==i.index?l+i.index:e.length,d=e.slice(l,c),u=d.match(/Price:\s*([\d,]+)/i),h=u?parseInt(u[1].replace(/,/g,""),10):0,m=d.match(/Price:\s*[\d,]+\s*(\w+)/i),g=m?m[1]:"ILS",x=d.match(/URL:\s*(https?:\/\/[^\s\n]+)/i),p=x?x[1]:void 0,f=d.match(/(?:Contact|Phone|WhatsApp):\s*(\+?[\d\s-]+)/i),y=f?f[1].replace(/[\s-]/g,""):void 0;h>0&&r.push({seller:s,price:h,currency:g,rating:a,url:p,phone:y})}return r}function er(e){let t;let r=[];if(!e.match(/=== BUNDLE OPPORTUNITIES \((\d+) stores\) ===/))return[];let s=e.indexOf("=== BUNDLE OPPORTUNITIES"),a=e.slice(s+30).match(/\n===\s+[^B]/),o=a?s+30+a.index:e.length,n=e.slice(s,o),l=/(\d+)\.\s+([^\n]+?)(?:\s+\(Rating:\s*([\d.]+)\/5\))?\n([\s\S]*?)(?=\n\d+\.|$)/g;for(;null!==(t=l.exec(n));){let e;let s=t[2].trim(),a=t[3]?parseFloat(t[3]):void 0,o=t[4],n=o.match(/Offers\s+(\d+)\/(\d+)\s+products/),l=n?parseInt(n[1]):0,i=n?parseInt(n[2]):0,c=[],d=/^\s+-\s+([^:]+):\s+([\d,]+)\s+(\w+)(?:\s*\|\s*(https?:\/\/[^\s]+))?/gm;for(;null!==(e=d.exec(o));)c.push({name:e[1].trim(),price:parseInt(e[2].replace(/,/g,""),10),currency:e[3],url:e[4]||void 0});let u=o.match(/Total:\s+([\d,]+)/),h=u?parseInt(u[1].replace(/,/g,""),10):0,m=o.match(/Contact:\s*(\+?[\d\s-]+)/),g=m?m[1].replace(/[\s-]/g,""):void 0;h>0&&r.push({storeName:s,rating:a,productCount:l,totalProducts:i,products:c,totalPrice:h,contact:g})}return r}}},function(e){e.O(0,[929,425,971,117,744],function(){return e(e.s=2177)}),_N_E=e.O()}]);